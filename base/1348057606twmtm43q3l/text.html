<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'DejaVu Sans'; font-size:11pt; font-weight:400; font-style:normal;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:10pt; font-weight:600;">Backup в Linux: настраиваем rsync-сервер</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:10pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:10pt;">2010-05-05 от ashep </span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:10pt;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:10pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:10pt;">Систем для создания и управления резервными копиями в Linux создано великое множество. Не столько создано, сколько портировано с других систем, но суть та же. Понятное дело, что если вы администрируете сеть предприятия, состоящую ну никак не из десятка компьютеров, а являющую собой большой парк машин, то вам вполне  подойдёт что-то вроде Amanda или ей подобных. В этой заметке я не буду рассматривать такой случай. Здесь я хочу рассказать о простом и удобном для меня способе создания резервных копий важных данных, имея в наличии небольшой набор компьютеров и установленную по-умолчанию практически во всех дистрибутивах утилиту rsync.</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:10pt;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:10pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:10pt; font-weight:600;">Почему rsync?</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:10pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:10pt;">Вообще, когда мы говорим о резервном копировании данных, то мы как правило имеем ввиду копирование этих самых данных из места А в место Б на случай, если с данными в месте А что-то случится и они станут недоступными. Вариантов места Б множество: оптические диски, стримеры, жёсткие диски, короче всё, что может данные хранить. Одним из наиболее важных требований к хранилищу резервных копий является требование, чтобы хранилище физически располагалось  подальше от основного места хранения данных. Понятное дело, что случившийся пожар не будет разбираться какой сервер уничтожать, а какой оставлять, поскольку у вас там резервные копии.</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:10pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:10pt;">Раз уж речь идёт о географической распределённости и использование каналов передачи данных, то уже при более-менее существенном объёме данных может резко встать вопрос о нагрузке на используемый канал передачи. Именно по этой причине эффективность cp, rcp, scp и прочих инструментах, копирующих изменённые файлы целиком, снижается в разы.</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:10pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:10pt;">rsync, разработанная как замена rcp, позволяет копировать файл не целиком, а частично, лишь изменённые его части. Для этого используется алгоритм, предложенный Andrew Tridgell и Paul Mackerras. Об этом алгоритме достаточно много написано, в том числе и на русском языке, поэтому всех интересующихся отсылаю по ссылкам.</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:10pt;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:10pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:10pt; font-weight:600;">Немного об rsync</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:10pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:10pt;">Что rsync умеет:</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:10pt;"><br /></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-size:10pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">синхронизировать целые каталоги и файловые системы;</li>
<li style=" font-size:10pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">сохранять при синхронизации символические и жёсткие ссылки, владельцев файлов/каталогов, права доступа, файлы устройств и временные метки;</li>
<li style=" font-size:10pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">для работы программы не нужны права суперпользователя;</li>
<li style=" font-size:10pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">использование внутренней конвейерной обработки снижает время обработки нескольких файлов одновременно;</li>
<li style=" font-size:10pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">может использовать rsh, ssh или же просто сокеты в качестве транспорта.</li></ul>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:10pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:10pt;">rsync может синхронизировать файлы как в пределах локальной системы, так и за её пределы, а также из-за её пределов. Правда выполнять синхронизацию между двумя удалёнными системами она, к сожалению, не умеет :(</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:10pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:10pt;">Существует два способа связи rsync с удалённой системой: через оболочку, например ssh, или же при помощи подключения к rsync, запущенной на удалённой системе в режиме демона. Поскольку rsync никак не шифрует трафик, то при использовании незащищённого соединения предпочтительней, конечно, использовать ssh в качестве транспорта. В данной статье, однако, я использую «родной» rsync-транспорт для примеров. Делаю это сознательно лишь с целью осветить настройку rsync-демона и об ипользовании ssh-транспорта, надеюсь, ещё расскажу в будущем.</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:10pt;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:10pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:10pt; font-weight:600;">Структура сети</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:10pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:10pt;">Как говорила некогда моя учительница русского: «У каждого свой Пушкин». Думается, что и сеть у каждого своя :-) В качестве примера я привожу свою небольшую сеть и свою схему резервного копирования. Для своих же собственных нужд, я уверен, вы сотворите что-то своё, невероятное и неповторимое, как тот самый велосипед :-)</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:10pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:10pt;">Итак, у меня имеется два сервера (я использую их оба, ибо чем больше копий — тем спится спокойней), разделённых большим расстоянием и каналом связи пропускной способностью порядка 15 Мбит/сек. К каждому из серверов посредством стамегабитного Ethernet подключены рабочие станции, с которых я и делаю резервные копии. Назовём сервера именами S1 и S2, а рабочие станции — буквами P1 и P2. Что-то наподобие этого:</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:10pt;"><br /></p>
<p align="center" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image23812.png" /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:10pt;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:10pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:10pt; font-weight:600;">Схема резервного копирования</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:10pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:10pt;">От того, насколько тщательно вы продумаете схему резервного копирования ваших данных, зависит многое: от эффективности использования каналов передачи данных до корректности выполнения самого копирования. Конечно, если вы просто копируете каталог из точки А в точку Б — мало что может произойти непредвиденного. Однако если вы собираетесь организовывать хранение копий на нескольких серверах, то обязательно всё продумайте как можно тщательней.</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:10pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:10pt;">В моём же примере всё достаточно просто. Рабочая станция P1 копирует данные на сервер S1, а рабочая станция P2 — на сервер S2. После чего между серверами происходит обмен содержимым каталогов с резервными копиями. Таки образом резервные копии данных каждой рабочей станции оказываются и на одном, и на другом серверах.</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:10pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:10pt;">Очень важный момент в такой схеме — это исключить одновременный запуск синхронизации с S1 на S2 и S2 на S1, поскольку это увеличит загрузку и без того загруженного канала передачи, а также потребление ресурсов самих серверов, на которых помимо rsync ещё есть чему работать. И второй момент: думаю, логично постараться избежать запуска межсерверной синхронизации одновременно с работающим процессом резервного копирования данных с рабочей станции. Не забудьте об этом позаботиться во время настройки выполнения скриптов в cronе.</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:10pt;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:10pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:10pt; font-weight:600;">Настройка rsync-демона</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:10pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:10pt;">Как правило в дистрибутивах Linux/Unix утилита rsync включена по-умолчанию в перечень устанавливаемых программ. Если вы сомневаетесь в том, что она присутствует в вашей системе, проверьте это командой:</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:10pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a1009;">which rsync</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:10pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:10pt;">Далее в статье подразумевается, что у вас установлена Ubuntu 10.04 Server Edition. Я не знаю, насколько в других дистрибутивах всё так же, как и в ней, но у меня кроме неё ничего нет, поэто всё буду показывать на примере этого дистрибутива.</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:10pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:10pt;">Итак, первым делом необходимо проверить, настроен ли автоматический запуск демона rsync при загрузке системы. Для этого просмотрите содержимое файла </span><span style=" font-family:'Courier New'; font-size:10pt; color:#6a1009;">/etc/default/rsync</span><span style=" font-size:10pt;"> и убедитесь, что </span><span style=" font-family:'Courier New'; font-size:10pt; color:#6a1009;">RSYNC_ENABLE=true</span><span style=" font-size:10pt;">.</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:10pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:10pt;">Теперь необходимо создать файл конфигурации демона. Он должен находиться в </span><span style=" font-family:'Courier New'; font-size:10pt; color:#6a1009;">/etc/rsyncd.conf</span><span style=" font-size:10pt;">. По-умолчанию он отсутствует, поэтому даже с </span><span style=" font-family:'Courier New'; font-size:10pt; color:#6a1009;">RSYNC_ENABLE=true</span><span style=" font-size:10pt;"> демон запуститься не сможет.</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:10pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:10pt;">Немного о структуре файла </span><span style=" font-family:'Courier New'; font-size:10pt; color:#6a1009;">/etc/rsyncd.conf</span><span style=" font-size:10pt;">. Формат файла достаточно прост и идентичен ini-файлам. В нём описываются «глобальные» параметры, контролирующие поведение демона в целом, а также «модули», описывающие доступ к конкретным каталогам файловой системы. Обо всё этом можно в полном объёме ознакомиться при помощи </span><span style=" font-family:'Courier New'; font-size:10pt; color:#6a1009;">man rsyncd.conf</span><span style=" font-size:10pt;">, я же ограничусь использованием нужных мне параметров с их описанием.</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:10pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:10pt;">Глобальных параметров менять никаких не пришлось, поэтому я сразу перешёл к настройке модуля.</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:10pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:10pt;">Прежде чем мы будем описывать модуль, необходимо определиться в каком каталоге мы будем хранить получаемые от удалённых компьютеров данные. В моём примере это будет каталог </span><span style=" font-family:'Courier New'; font-size:10pt; color:#6a1009;">/var/backups/my_network</span><span style=" font-size:10pt;">. Для обоих серверов конфигурация модуля будет идентична, за исключением, естественно, параметра </span><span style=" font-family:'Courier New'; font-size:10pt; color:#6a1009;">hosts allow</span><span style=" font-size:10pt;">.</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:10pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:10pt;">Рассмотрим, что у меня получилось:</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:10pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a1009;">[backups]</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a1009;"> comment = For backups</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a1009;"> path = /var/backups/my_network</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a1009;"> use chroot = true</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a1009;"> uid = backup</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a1009;"> gid = backup</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a1009;"> log file = /var/log/rsyncd/backups.log</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a1009;"> read only = false</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a1009;"> write only = false</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a1009;"> hosts allow = s1 p2</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a1009;"> hosts deny = *</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a1009;"> transfer logging = false</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:10pt;"><br /></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-size:10pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Описание каждого модуля начинается с его имени, заключённого в квадратные скобки;</li>
<li style=" font-size:10pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">параметр <span style=" font-family:'Courier New'; color:#6a1009;">comment</span> может содержать комментарий к модулю, которое будет видно удалённой системе при просмотре перечня модулей этого сервера;</li>
<li style=" font-size:10pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">парамет<span style=" font-family:'Courier New'; color:#6a1009;">р path</span> содержит путь к каталогу на файловой системе, с которой будет работать данный модуль;</li>
<li style=" font-size:10pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">параметр <span style=" font-family:'Courier New'; color:#6a1009;">use chroot</span> заставляет <span style=" font-family:'Courier New'; color:#6a1009;">rsync</span> после установки соединения выполнить <span style=" font-family:'Courier New'; color:#6a1009;">chroot</span> в каталог, указанный в параметре <span style=" font-family:'Courier New'; color:#6a1009;">path</span>. Это повышает безопасность, однако для использования этого параметра демон должен быть запущен суперпользователем;</li>
<li style=" font-size:10pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">параметры <span style=" font-family:'Courier New'; color:#6a1009;">uid</span> и <span style=" font-family:'Courier New'; color:#6a1009;">gid</span> заставляют <span style=" font-family:'Courier New'; color:#6a1009;">rsync</span> после установки соединения вести всю работу с файлами от имени указанных пользователя и (или) группы;</li>
<li style=" font-size:10pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a1009;">log file</span> указывает демону место для ведения протокола работы;</li>
<li style=" font-size:10pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">параметры <span style=" font-family:'Courier New'; color:#6a1009;">read only</span> и <span style=" font-family:'Courier New'; color:#6a1009;">write only</span>, установленные в <span style=" font-family:'Courier New'; color:#6a1009;">false</span> разрешают удалённой системе работать в модулем в как в режиме чтения, так и в режиме записи;</li>
<li style=" font-size:10pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a1009;">hosts allow</span> и <span style=" font-family:'Courier New'; color:#6a1009;">hosts deny</span> задают перечень хостов (разделённых пробелами), которым разрешено и запрещено работать с модулем;</li>
<li style=" font-size:10pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">параметр <span style=" font-family:'Courier New'; color:#6a1009;">transfer logging</span> управляет ведением подробного протокола принятых/отданных данных. Устанавливать значение этого параметра в <span style=" font-family:'Courier New'; color:#6a1009;">true</span> я рекомендую разве что в целях отладки, поскольку размер этого файла будет стремительно расти при регулярных синхронизациях. Хотя, если уж очень нужно, можно и <span style=" font-family:'Courier New'; color:#6a1009;">logrotate</span> на него натравить.</li></ul>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:10pt;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:10pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:10pt;">После создания и сохранения файла </span><span style=" font-family:'Courier New'; font-size:10pt; color:#6a1009;">/etc/rsync.conf</span><span style=" font-size:10pt;"> проверьте, чтобы пользователь, указанный в параметре uid имел право на запись в этот каталог.</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:10pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:10pt;">Теперь, когда конфигурационный файл создан и всё проверено, можно запускать демон </span><span style=" font-family:'Courier New'; font-size:10pt; color:#6a1009;">rsync</span><span style=" font-size:10pt;">:</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:10pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a1009;">sudo service rsync start</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:10pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:10pt;">Проверить состояние демона вы всегда можете проверить командой:</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:10pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a1009;">sudo service rsync status</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:10pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:10pt;">Если демон был успешно запущен, то можно попробовать подключиться к нему по протоколу </span><span style=" font-family:'Courier New'; font-size:10pt; color:#6a1009;">rsync</span><span style=" font-size:10pt;"> и получить список доступных модулей:</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:10pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a1009;">rsync rsync://localhost</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:10pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:10pt;">В ответ вы должны получить примерно следующее:</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:10pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a1009;">backups         For backups</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:10pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:10pt;">Первое — это имя модуля, а второе — это комментарий к нему.</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:10pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:10pt;">На этом процесс настройки rsync-сервера для приёма резервных копий от </span><span style=" font-family:'Courier New'; font-size:10pt; color:#6a1009;">rsync</span><span style=" font-size:10pt;">-клиентов можно считать завершённым. В следующих статьях мы рассмотрим работу rsync со стороны клиента и автоматизируем процесс создания резервных копий, а также синхронизацию их между серверами.</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:10pt;"><br /></p></body></html>