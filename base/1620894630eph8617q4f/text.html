<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'DejaVu Sans'; font-size:11pt; font-weight:400; font-style:normal;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">В этой статье вы узнаете, как разобрать арифметическое выражение в привычном формате из строки в структуру данных “дерево”, а затем путём обхода дерева вычислить выражение. Другими словами, мы пишем калькулятор.</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-style:italic; color:#323232;">У статьи есть </span><a href="https://github.com/ps-group/procedural_calculator"><span style=" font-style:italic; text-decoration: underline; color:#2a7ae2;">пример на github</span></a><span style=" font-style:italic; color:#323232;">, он написан в процедурном стиле на C++.</span></p>
<h2 align="center" style=" margin-top:32px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="wow0"></a><span style=" font-size:x-large; font-weight:600; color:#000000;">B</span><span style=" font-size:x-large; font-weight:600; color:#000000;">NF-нотация арифметических выражений</span></h2>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">Нас интересуют арифметические выражения без скобок и с пятью операторами:</span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" color:#000000;" style=" margin-top:0px; margin-bottom:0px; margin-left:30px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:16px;">&quot;+&quot;</span><span style=" font-size:18px;"> - сложение</span></li>
<li style=" color:#000000;" style=" margin-top:0px; margin-bottom:0px; margin-left:30px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:16px;">&quot;-&quot;</span><span style=" font-size:18px;"> - вычитание</span></li>
<li style=" color:#000000;" style=" margin-top:0px; margin-bottom:0px; margin-left:30px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:16px;">&quot;*&quot;</span><span style=" font-size:18px;"> - умножение</span></li>
<li style=" color:#000000;" style=" margin-top:0px; margin-bottom:0px; margin-left:30px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:16px;">&quot;/&quot;</span><span style=" font-size:18px;"> - деление (получение частного от деления)</span></li>
<li style=" color:#000000;" style=" margin-top:0px; margin-bottom:15px; margin-left:30px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:16px;">&quot;%&quot;</span><span style=" font-size:18px;"> - деление по модулю (получение остатка от деления)</span></li></ul>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">Примеры таких выражений:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">12 / 12 / 12 =&gt; 0.0833333</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">25 + 17 / 45 / 2 =&gt; 25.1889</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">Синтаксис выражений можно описать в BNF-нотации (также известной как нотация Бекуса-Наура). Такая нотация ещё называется грамматикой, и выглядит как набор правил:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">expression ::= add_sub_expr</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">add_sub_expr ::= mul_div_expr '+' add_sub_expr</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    | mul_div_expr '-' add_sub_expr</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    | mul_div_expr</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">mul_div_expr ::= atom_expr '*' mul_div_expr</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    | atom_expr '/' mul_div_expr</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    | atom_expr '%' mul_div_expr</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    | atom_expr</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">atom_expr ::= [0-9]+</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">Данная грамматика учитывает неравный приоритет операторов: в выражении 1 + 2 * 2 вы сначала должны свернуть 2 * 2 как mul_div_expr по правилу atom_expr '*' mul_div_expr, а потом уже свернуть 1 + mul_div_expr в add_sub_expr. Раскроем эту мысль подробнее с помощью пошаговой трассировки сворачивания правил грамматики:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">1</span><span style=" font-weight:600; color:#000000;">)</span><span style=" color:#000000;"> 17 + 25 / 7</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">2</span><span style=" font-weight:600; color:#000000;">)</span><span style=" color:#000000;"> atom_expr + 25 / 7 </span><span style=" font-style:italic; color:#999988;"># правило atom_expr ::= [0-9]+</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">3</span><span style=" font-weight:600; color:#000000;">)</span><span style=" color:#000000;"> atom_expr + atom_expr / 7 </span><span style=" font-style:italic; color:#999988;"># правило atom_expr ::= [0-9]+</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">4</span><span style=" font-weight:600; color:#000000;">)</span><span style=" color:#000000;"> atom_expr + atom_expr / atom_expr </span><span style=" font-style:italic; color:#999988;"># правило atom_expr ::= [0-9]+</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">5</span><span style=" font-weight:600; color:#000000;">)</span><span style=" color:#000000;"> mul_div_expr + atom_expr / atom_expr </span><span style=" font-style:italic; color:#999988;"># правило mul_div_expr ::= atom_expr</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">6</span><span style=" font-weight:600; color:#000000;">)</span><span style=" color:#000000;"> mul_div_expr + atom_expr / mul_div_expr </span><span style=" font-style:italic; color:#999988;"># правило mul_div_expr ::= atom_expr</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">7</span><span style=" font-weight:600; color:#000000;">)</span><span style=" color:#000000;"> mul_div_expr + mul_div_expr </span><span style=" font-style:italic; color:#999988;"># правило mul_div_expr ::= atom_expr '/' mul_div_expr</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">8</span><span style=" font-weight:600; color:#000000;">)</span><span style=" color:#000000;"> mul_div_expr + add_sub_expr </span><span style=" font-style:italic; color:#999988;"># правило add_sub_expr ::= mul_div_expr</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">9</span><span style=" font-weight:600; color:#000000;">)</span><span style=" color:#000000;"> add_sub_expr </span><span style=" font-style:italic; color:#999988;"># add_sub_expr ::= mul_div_expr '+' add_sub_expr</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-style:italic; color:#999988;"><br /></p>
<h2 align="center" style=" margin-top:32px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="wow1"></a><span style=" font-size:x-large; font-weight:600; color:#000000;">С</span><span style=" font-size:x-large; font-weight:600; color:#000000;">верху вниз: строим и обходим дерево выражения</span></h2>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">Дерево выражения — это вот такая прикольная штука:</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p align="center" style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image1620894660kg2j1l51up.png" /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">Способ превращения выражения в дерево зависит от приоритета операторов, который можно сменить расстановкой скобок. В качестве упражнения попробуйте восстановить тексты двух выражений, деревья которых нарисованы ниже:</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p align="center" style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image1620894690h9giwr5ts8.png" /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">Вычислить выражение по дереву легко и просто, достаточно обойти слева направо в глубину, применяя оператор в каждом нелистовом узле к дочерним узлам. Главный вопрос — как собрать дерево, имея строковое выражение?</span></p>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">Мы воспользуемся принципом нисходящего разбора, и применим нисходящий подход к проектированию программы. Сначала опишем функцию, которая получает выражение в виде строки и вычисляет его как число с плавающей точкой:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600; color:#445588;">double</span><span style=" color:#000000;"> </span><span style=" font-weight:600; color:#990000;">Calculate</span><span style=" color:#000000;">(</span><span style=" font-weight:600; color:#000000;">const</span><span style=" color:#000000;"> std</span><span style=" font-weight:600; color:#000000;">::</span><span style=" color:#000000;">string </span><span style=" font-weight:600; color:#000000;">&amp;</span><span style=" color:#000000;">expression)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">{</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    Expression </span><span style=" font-weight:600; color:#000000;">*</span><span style=" color:#000000;">pExpression </span><span style=" font-weight:600; color:#000000;">=</span><span style=" color:#000000;"> CreateExpression(expression);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    </span><span style=" font-weight:600; color:#000000;">const</span><span style=" color:#000000;"> </span><span style=" font-weight:600; color:#445588;">double</span><span style=" color:#000000;"> result </span><span style=" font-weight:600; color:#000000;">=</span><span style=" color:#000000;"> CalculateExpression(pExpression);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    DisposeExpression(pExpression);</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    </span><span style=" font-weight:600; color:#000000;">return</span><span style=" color:#000000;"> result;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">}</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">Expression — это узел дерева. Интересно, что узел дерева сам является деревом, ведь дерево — это рекурсивное понятие, не так ли? В листьях дерева находятся</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600; color:#000000;">struct</span><span style=" color:#000000;"> Expression;</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-style:italic; color:#999988;">// Expression tree node operation code.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600; color:#000000;">enum</span><span style=" color:#000000;"> </span><span style=" font-weight:600; color:#000000;">class</span><span style=" color:#000000;"> </span><span style=" font-weight:600; color:#445588;">Operation</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">{</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    NOP, </span><span style=" font-style:italic; color:#999988;">// just a value</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    ADD, </span><span style=" font-style:italic; color:#999988;">// +</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    SUB, </span><span style=" font-style:italic; color:#999988;">// -</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    MUL, </span><span style=" font-style:italic; color:#999988;">// *</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    DIV, </span><span style=" font-style:italic; color:#999988;">// /</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    MOD, </span><span style=" font-style:italic; color:#999988;">// %</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">};</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-style:italic; color:#999988;">// Expression tree node is expression itself,</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-style:italic; color:#999988;">//  since expressions are recursively defined.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600; color:#000000;">struct</span><span style=" color:#000000;"> Expression</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">{</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    </span><span style=" font-weight:600; color:#445588;">double</span><span style=" color:#000000;"> value </span><span style=" font-weight:600; color:#000000;">=</span><span style=" color:#000000;"> </span><span style=" color:#009999;">0</span><span style=" color:#000000;">;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    Operation op </span><span style=" font-weight:600; color:#000000;">=</span><span style=" color:#000000;"> Operation</span><span style=" font-weight:600; color:#000000;">::</span><span style=" color:#000000;">NOP;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    Expression </span><span style=" font-weight:600; color:#000000;">*</span><span style=" color:#000000;">pLeft </span><span style=" font-weight:600; color:#000000;">=</span><span style=" color:#000000;"> </span><span style=" color:#0086b3;">nullptr</span><span style=" color:#000000;">;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    Expression </span><span style=" font-weight:600; color:#000000;">*</span><span style=" color:#000000;">pRight </span><span style=" font-weight:600; color:#000000;">=</span><span style=" color:#000000;"> </span><span style=" color:#0086b3;">nullptr</span><span style=" color:#000000;">;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">};</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">Вычисление выражения по дереву:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600; color:#445588;">double</span><span style=" color:#000000;"> </span><span style=" font-weight:600; color:#990000;">CalculateExpression</span><span style=" color:#000000;">(Expression </span><span style=" font-weight:600; color:#000000;">*</span><span style=" color:#000000;">pExpr)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">{</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    </span><span style=" font-style:italic; color:#999988;">// Для листовых узлов возвращаем их численное значение</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    </span><span style=" font-style:italic; color:#999988;">//  если бы у нас была поддержка переменных, мы бы выполнили</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    </span><span style=" font-style:italic; color:#999988;">//  запрос значения переменной по имени в ассоциативном массиве переменных</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    </span><span style=" font-weight:600; color:#000000;">if</span><span style=" color:#000000;"> (pExpr</span><span style=" font-weight:600; color:#000000;">-&gt;</span><span style=" color:#000000;">op </span><span style=" font-weight:600; color:#000000;">==</span><span style=" color:#000000;"> Operation</span><span style=" font-weight:600; color:#000000;">::</span><span style=" color:#000000;">NOP)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">        </span><span style=" font-weight:600; color:#000000;">return</span><span style=" color:#000000;"> pExpr</span><span style=" font-weight:600; color:#000000;">-&gt;</span><span style=" color:#000000;">value;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    }</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    </span><span style=" font-style:italic; color:#999988;">// Вычисляем выражения в левом и в правом поддеревьях</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    assert(pExpr</span><span style=" font-weight:600; color:#000000;">-&gt;</span><span style=" color:#000000;">pLeft);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    assert(pExpr</span><span style=" font-weight:600; color:#000000;">-&gt;</span><span style=" color:#000000;">pRight);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    CalculateExpression(pExpr</span><span style=" font-weight:600; color:#000000;">-&gt;</span><span style=" color:#000000;">pLeft);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    CalculateExpression(pExpr</span><span style=" font-weight:600; color:#000000;">-&gt;</span><span style=" color:#000000;">pRight);</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    </span><span style=" font-style:italic; color:#999988;">// Применяем операцию текущего узла</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    </span><span style=" font-weight:600; color:#000000;">switch</span><span style=" color:#000000;"> (pExpr</span><span style=" font-weight:600; color:#000000;">-&gt;</span><span style=" color:#000000;">op)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    </span><span style=" font-weight:600; color:#000000;">case</span><span style=" color:#000000;"> Operation:</span><span style=" font-weight:600; color:#000000;">:</span><span style=" color:#000000;">ADD</span><span style=" font-weight:600; color:#000000;">:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">        pExpr</span><span style=" font-weight:600; color:#000000;">-&gt;</span><span style=" color:#000000;">value </span><span style=" font-weight:600; color:#000000;">=</span><span style=" color:#000000;"> pExpr</span><span style=" font-weight:600; color:#000000;">-&gt;</span><span style=" color:#000000;">pLeft</span><span style=" font-weight:600; color:#000000;">-&gt;</span><span style=" color:#000000;">value </span><span style=" font-weight:600; color:#000000;">+</span><span style=" color:#000000;"> pExpr</span><span style=" font-weight:600; color:#000000;">-&gt;</span><span style=" color:#000000;">pRight</span><span style=" font-weight:600; color:#000000;">-&gt;</span><span style=" color:#000000;">value;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">        </span><span style=" font-weight:600; color:#000000;">break</span><span style=" color:#000000;">;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    </span><span style=" font-weight:600; color:#000000;">case</span><span style=" color:#000000;"> Operation:</span><span style=" font-weight:600; color:#000000;">:</span><span style=" color:#000000;">SUB</span><span style=" font-weight:600; color:#000000;">:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">        pExpr</span><span style=" font-weight:600; color:#000000;">-&gt;</span><span style=" color:#000000;">value </span><span style=" font-weight:600; color:#000000;">=</span><span style=" color:#000000;"> pExpr</span><span style=" font-weight:600; color:#000000;">-&gt;</span><span style=" color:#000000;">pLeft</span><span style=" font-weight:600; color:#000000;">-&gt;</span><span style=" color:#000000;">value </span><span style=" font-weight:600; color:#000000;">-</span><span style=" color:#000000;"> pExpr</span><span style=" font-weight:600; color:#000000;">-&gt;</span><span style=" color:#000000;">pRight</span><span style=" font-weight:600; color:#000000;">-&gt;</span><span style=" color:#000000;">value;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">        </span><span style=" font-weight:600; color:#000000;">break</span><span style=" color:#000000;">;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    </span><span style=" font-weight:600; color:#000000;">case</span><span style=" color:#000000;"> Operation:</span><span style=" font-weight:600; color:#000000;">:</span><span style=" color:#000000;">MUL</span><span style=" font-weight:600; color:#000000;">:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">        pExpr</span><span style=" font-weight:600; color:#000000;">-&gt;</span><span style=" color:#000000;">value </span><span style=" font-weight:600; color:#000000;">=</span><span style=" color:#000000;"> pExpr</span><span style=" font-weight:600; color:#000000;">-&gt;</span><span style=" color:#000000;">pLeft</span><span style=" font-weight:600; color:#000000;">-&gt;</span><span style=" color:#000000;">value </span><span style=" font-weight:600; color:#000000;">*</span><span style=" color:#000000;"> pExpr</span><span style=" font-weight:600; color:#000000;">-&gt;</span><span style=" color:#000000;">pRight</span><span style=" font-weight:600; color:#000000;">-&gt;</span><span style=" color:#000000;">value;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">        </span><span style=" font-weight:600; color:#000000;">break</span><span style=" color:#000000;">;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    </span><span style=" font-weight:600; color:#000000;">case</span><span style=" color:#000000;"> Operation:</span><span style=" font-weight:600; color:#000000;">:</span><span style=" color:#000000;">DIV</span><span style=" font-weight:600; color:#000000;">:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">        pExpr</span><span style=" font-weight:600; color:#000000;">-&gt;</span><span style=" color:#000000;">value </span><span style=" font-weight:600; color:#000000;">=</span><span style=" color:#000000;"> pExpr</span><span style=" font-weight:600; color:#000000;">-&gt;</span><span style=" color:#000000;">pLeft</span><span style=" font-weight:600; color:#000000;">-&gt;</span><span style=" color:#000000;">value </span><span style=" font-weight:600; color:#000000;">/</span><span style=" color:#000000;"> pExpr</span><span style=" font-weight:600; color:#000000;">-&gt;</span><span style=" color:#000000;">pRight</span><span style=" font-weight:600; color:#000000;">-&gt;</span><span style=" color:#000000;">value;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">        </span><span style=" font-weight:600; color:#000000;">break</span><span style=" color:#000000;">;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    </span><span style=" font-weight:600; color:#000000;">case</span><span style=" color:#000000;"> Operation:</span><span style=" font-weight:600; color:#000000;">:</span><span style=" color:#000000;">MOD</span><span style=" font-weight:600; color:#000000;">:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">        pExpr</span><span style=" font-weight:600; color:#000000;">-&gt;</span><span style=" color:#000000;">value </span><span style=" font-weight:600; color:#000000;">=</span><span style=" color:#000000;"> fmod(pExpr</span><span style=" font-weight:600; color:#000000;">-&gt;</span><span style=" color:#000000;">pLeft</span><span style=" font-weight:600; color:#000000;">-&gt;</span><span style=" color:#000000;">value, pExpr</span><span style=" font-weight:600; color:#000000;">-&gt;</span><span style=" color:#000000;">pRight</span><span style=" font-weight:600; color:#000000;">-&gt;</span><span style=" color:#000000;">value);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">        </span><span style=" font-weight:600; color:#000000;">break</span><span style=" color:#000000;">;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    </span><span style=" font-weight:600; color:#000000;">case</span><span style=" color:#000000;"> Operation:</span><span style=" font-weight:600; color:#000000;">:</span><span style=" color:#000000;">NOP</span><span style=" font-weight:600; color:#000000;">:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">        assert(</span><span style=" color:#0086b3;">false</span><span style=" color:#000000;">);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">        </span><span style=" font-weight:600; color:#000000;">break</span><span style=" color:#000000;">;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    }</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    </span><span style=" font-weight:600; color:#000000;">return</span><span style=" color:#000000;"> pExpr</span><span style=" font-weight:600; color:#000000;">-&gt;</span><span style=" color:#000000;">value;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">}</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<h2 align="center" style=" margin-top:32px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="wow2"></a><span style=" font-size:x-large; font-weight:600; color:#000000;">П</span><span style=" font-size:x-large; font-weight:600; color:#000000;">ревращаем правила в функции</span></h2>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">Мы хотим реализовать функцию Expression *CreateExpression(const std::string &amp;expression);, которая выполняет разбор строки и в случае успеха возвращает указатель на выражение. Для этого на каждое из правил в BNF-нотации объявим по одной функции. Соглашения будут таковы:</span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" color:#000000;" style=" margin-top:0px; margin-bottom:0px; margin-left:30px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:18px;">В случае успешного разбора функция возвращает </span><span style=" font-size:16px;">Expression *</span><span style=" font-size:18px;">, то есть стек вызовов функций уменьшается на одну запись</span></li>
<li style=" color:#000000;" style=" margin-top:0px; margin-bottom:0px; margin-left:30px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:18px;">В случае ошибки функция корректно удаляет выделенную память и выбрасывает исключение, то есть начинается экстренная раскрутка стека вызовов функций</span></li>
<li style=" color:#000000;" style=" margin-top:0px; margin-bottom:0px; margin-left:30px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:18px;">Функция может рекурсивно вызывать себя или другие функции</span></li>
<li style=" color:#000000;" style=" margin-top:0px; margin-bottom:15px; margin-left:30px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:18px;">Функция принимает изменяемую ссылку на строку, и в случае успешного разбора своего участка отсекает этот участок из строки, оставляя всё, что находится правее. Например, в выражении </span><span style=" font-size:16px;">18 - 7</span><span style=" font-size:18px;"> после успешного разбора первого </span><span style=" font-size:16px;">atom_expr</span><span style=" font-size:18px;"> подстрока “18” должна быть убрана из строки</span></li></ul>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">Expression *ParseAtom(std::string &amp;str);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">Expression *ParseMulDiv(std::string &amp;str);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">Expression *ParseAddSub(std::string &amp;str);</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">В псевдокоде реализация разбора atom должна выглядеть так:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">Expression </span><span style=" font-weight:600; color:#000000;">*</span><span style=" font-weight:600; color:#990000;">ParseAtom</span><span style=" color:#000000;">(std</span><span style=" font-weight:600; color:#000000;">::</span><span style=" color:#000000;">string </span><span style=" font-weight:600; color:#000000;">&amp;</span><span style=" color:#000000;">str)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">{</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    </span><span style=" font-style:italic; color:#999988;">// Попытаться считать число.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    </span><span style=" font-style:italic; color:#999988;">// Если удалось, пропустить считанную часть str,</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    </span><span style=" font-style:italic; color:#999988;">//  создать Expression* и вернуть его.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    </span><span style=" font-style:italic; color:#999988;">// Иначе бросаем исключение</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">}</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">Наивная реализация разбора expr_mul_div могла бы выглядеть так:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">Expression </span><span style=" font-weight:600; color:#000000;">*</span><span style=" font-weight:600; color:#990000;">ParseMulDiv</span><span style=" color:#000000;">(std</span><span style=" font-weight:600; color:#000000;">::</span><span style=" color:#000000;">string </span><span style=" font-weight:600; color:#000000;">&amp;</span><span style=" color:#000000;">str)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">{</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    </span><span style=" font-style:italic; color:#999988;">// Попытаться считать atom (не удалось - бросаем исключение).</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    </span><span style=" font-style:italic; color:#999988;">// Проверить, есть ли впереди оператор *, / или %</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    </span><span style=" font-style:italic; color:#999988;">//  если нет, возвращаем Expression* от atom</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    </span><span style=" font-style:italic; color:#999988;">//  если да, считываем и пропускаем оператор</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    </span><span style=" font-style:italic; color:#999988;">// Попытаться считать atom (не удалось - бросаем исключение).</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    </span><span style=" font-style:italic; color:#999988;">// Формируем Expression из двух atom и оператора</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">}</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">К сожалению, такая реализация не сможет разобрать выражение “a</span><span style=" font-style:italic; color:#000000;">b</span><span style=" color:#000000;">c”, в котором число операций одного уровня — 3 или более. Сразу заметим, что в разборе таких выражений надо учитывать жестокие правила ассоциативности, например, «2/2/2» правильно вычисляется как «(2/2)/2=0,5», а не «2/(2/2)=2»</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p align="center" style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image1620894734psn9zjqpjd.png" /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">Именно из-за левой ассоциативности деления такая реализация не подходит (но она подошла бы для правоассоциативных правил, таких как присваивание):</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">Expression </span><span style=" font-weight:600; color:#000000;">*</span><span style=" font-weight:600; color:#990000;">ParseMulDiv</span><span style=" color:#000000;">(std</span><span style=" font-weight:600; color:#000000;">::</span><span style=" color:#000000;">string </span><span style=" font-weight:600; color:#000000;">&amp;</span><span style=" color:#000000;">str)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">{</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    </span><span style=" font-style:italic; color:#999988;">// Попытаться считать atom (не удалось - бросаем исключение).</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    </span><span style=" font-style:italic; color:#999988;">// Проверить, есть ли впереди оператор *, / или %</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    </span><span style=" font-style:italic; color:#999988;">//  если нет, возвращаем Expression* от atom</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    </span><span style=" font-style:italic; color:#999988;">//  если да, считываем и пропускаем оператор</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    </span><span style=" font-style:italic; color:#999988;">// Попытаться рекурсивно считать expr_mul_div (не удалось - бросаем исключение).</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    </span><span style=" font-style:italic; color:#999988;">// Формируем Expression из atom, expr_mul_div и оператора</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">}</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">Если же попытаться при разборе expr_mul_div в первую очередь искать вложенный expr_mul_div, то будет очевидная бесконечная рекурсия и следующее за ней переполнение стека программы. Поэтому нам ничего не остаётся, кроме как заменить рекурсию на цикл, и на каждой итерации цикла присоединять уже собранный expr_mul_div к новому как левое поддерево.</span></p>
<h2 align="center" style=" margin-top:32px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="wow3"></a><span style=" font-size:x-large; font-weight:600; color:#000000;">Р</span><span style=" font-size:x-large; font-weight:600; color:#000000;">еализуем функции разбора</span></h2>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">В реализациях этих функций мы применим три дополнительные функции, которые по тем же принципам отсекают от строки пробельные символы, число и следующий оператор соответственно:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600; color:#445588;">void</span><span style=" color:#000000;"> </span><span style=" font-weight:600; color:#990000;">SkipSpaces</span><span style=" color:#000000;">(std</span><span style=" font-weight:600; color:#000000;">::</span><span style=" color:#000000;">string </span><span style=" font-weight:600; color:#000000;">&amp;</span><span style=" color:#000000;">expression)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">{</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    </span><span style=" font-weight:600; color:#445588;">size_t</span><span style=" color:#000000;"> numSize </span><span style=" font-weight:600; color:#000000;">=</span><span style=" color:#000000;"> </span><span style=" color:#009999;">0</span><span style=" color:#000000;">;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    </span><span style=" font-weight:600; color:#000000;">while</span><span style=" color:#000000;"> (numSize </span><span style=" font-weight:600; color:#000000;">&lt;</span><span style=" color:#000000;"> expression.size()</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">           </span><span style=" font-weight:600; color:#000000;">&amp;&amp;</span><span style=" color:#000000;"> (expression[numSize] </span><span style=" font-weight:600; color:#000000;">==</span><span style=" color:#000000;"> </span><span style=" color:#dd1144;">' '</span><span style=" color:#000000;">))</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">        </span><span style=" font-weight:600; color:#000000;">++</span><span style=" color:#000000;">numSize;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    }</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    expression </span><span style=" font-weight:600; color:#000000;">=</span><span style=" color:#000000;"> expression.substr(numSize);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">}</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-style:italic; color:#999988;">// Skips spaces, then reads until first non-digit character.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-style:italic; color:#999988;">// If successful, removes read characters from `expression`</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-style:italic; color:#999988;">//  and returns true.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600; color:#445588;">bool</span><span style=" color:#000000;"> </span><span style=" font-weight:600; color:#990000;">ParseDouble</span><span style=" color:#000000;">(std</span><span style=" font-weight:600; color:#000000;">::</span><span style=" color:#000000;">string </span><span style=" font-weight:600; color:#000000;">&amp;</span><span style=" color:#000000;">expression, </span><span style=" font-weight:600; color:#445588;">double</span><span style=" color:#000000;"> </span><span style=" font-weight:600; color:#000000;">&amp;</span><span style=" color:#000000;">result)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">{</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    std</span><span style=" font-weight:600; color:#000000;">::</span><span style=" color:#000000;">string remainingStr </span><span style=" font-weight:600; color:#000000;">=</span><span style=" color:#000000;"> expression;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    SkipSpaces(remainingStr);</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    </span><span style=" font-weight:600; color:#445588;">size_t</span><span style=" color:#000000;"> numSize </span><span style=" font-weight:600; color:#000000;">=</span><span style=" color:#000000;"> </span><span style=" color:#009999;">0</span><span style=" color:#000000;">;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    </span><span style=" font-weight:600; color:#000000;">if</span><span style=" color:#000000;"> (remainingStr.size() </span><span style=" font-weight:600; color:#000000;">&gt;</span><span style=" color:#000000;"> </span><span style=" color:#009999;">0</span><span style=" color:#000000;"> </span><span style=" font-weight:600; color:#000000;">&amp;&amp;</span><span style=" color:#000000;"> isdigit(remainingStr[</span><span style=" color:#009999;">0</span><span style=" color:#000000;">]))</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">        </span><span style=" font-weight:600; color:#000000;">while</span><span style=" color:#000000;"> (numSize </span><span style=" font-weight:600; color:#000000;">&lt;</span><span style=" color:#000000;"> remainingStr.size()</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">               </span><span style=" font-weight:600; color:#000000;">&amp;&amp;</span><span style=" color:#000000;"> isdigit(remainingStr[numSize]))</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">        {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">            </span><span style=" font-weight:600; color:#000000;">++</span><span style=" color:#000000;">numSize;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">        }</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">        result </span><span style=" font-weight:600; color:#000000;">=</span><span style=" color:#000000;"> std</span><span style=" font-weight:600; color:#000000;">::</span><span style=" color:#000000;">stod(remainingStr.substr(</span><span style=" color:#009999;">0</span><span style=" color:#000000;">, numSize));</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">        expression </span><span style=" font-weight:600; color:#000000;">=</span><span style=" color:#000000;"> remainingStr.substr(numSize);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">        </span><span style=" font-weight:600; color:#000000;">return</span><span style=" color:#000000;"> </span><span style=" color:#0086b3;">true</span><span style=" color:#000000;">;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    }</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    </span><span style=" font-weight:600; color:#000000;">return</span><span style=" color:#000000;"> </span><span style=" color:#0086b3;">false</span><span style=" color:#000000;">;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">}</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-style:italic; color:#999988;">// Skips spaces, then reads next operator symbol.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-style:italic; color:#999988;">// If successful, removes read characters from `expression`</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-style:italic; color:#999988;">//  and returns true.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600; color:#445588;">bool</span><span style=" color:#000000;"> </span><span style=" font-weight:600; color:#990000;">ParseOperator</span><span style=" color:#000000;">(std</span><span style=" font-weight:600; color:#000000;">::</span><span style=" color:#000000;">string </span><span style=" font-weight:600; color:#000000;">&amp;</span><span style=" color:#000000;">expression, Operation </span><span style=" font-weight:600; color:#000000;">&amp;</span><span style=" color:#000000;">op)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">{</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    std</span><span style=" font-weight:600; color:#000000;">::</span><span style=" color:#000000;">string remainingStr </span><span style=" font-weight:600; color:#000000;">=</span><span style=" color:#000000;"> expression;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    SkipSpaces(remainingStr);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    </span><span style=" font-weight:600; color:#000000;">if</span><span style=" color:#000000;"> (remainingStr.empty())</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">        op </span><span style=" font-weight:600; color:#000000;">=</span><span style=" color:#000000;"> Operation</span><span style=" font-weight:600; color:#000000;">::</span><span style=" color:#000000;">NOP;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">        </span><span style=" font-weight:600; color:#000000;">return</span><span style=" color:#000000;"> </span><span style=" color:#0086b3;">false</span><span style=" color:#000000;">;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    }</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    </span><span style=" font-weight:600; color:#000000;">switch</span><span style=" color:#000000;"> (remainingStr[</span><span style=" color:#009999;">0</span><span style=" color:#000000;">])</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    </span><span style=" font-weight:600; color:#000000;">case</span><span style=" color:#000000;"> </span><span style=" color:#dd1144;">'+'</span><span style=" color:#000000;">:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">        op </span><span style=" font-weight:600; color:#000000;">=</span><span style=" color:#000000;"> Operation</span><span style=" font-weight:600; color:#000000;">::</span><span style=" color:#000000;">ADD; </span><span style=" font-weight:600; color:#000000;">break</span><span style=" color:#000000;">;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    </span><span style=" font-weight:600; color:#000000;">case</span><span style=" color:#000000;"> </span><span style=" color:#dd1144;">'-'</span><span style=" color:#000000;">:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">        op </span><span style=" font-weight:600; color:#000000;">=</span><span style=" color:#000000;"> Operation</span><span style=" font-weight:600; color:#000000;">::</span><span style=" color:#000000;">SUB; </span><span style=" font-weight:600; color:#000000;">break</span><span style=" color:#000000;">;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    </span><span style=" font-weight:600; color:#000000;">case</span><span style=" color:#000000;"> </span><span style=" color:#dd1144;">'*'</span><span style=" color:#000000;">:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">        op </span><span style=" font-weight:600; color:#000000;">=</span><span style=" color:#000000;"> Operation</span><span style=" font-weight:600; color:#000000;">::</span><span style=" color:#000000;">MUL; </span><span style=" font-weight:600; color:#000000;">break</span><span style=" color:#000000;">;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    </span><span style=" font-weight:600; color:#000000;">case</span><span style=" color:#000000;"> </span><span style=" color:#dd1144;">'/'</span><span style=" color:#000000;">:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">        op </span><span style=" font-weight:600; color:#000000;">=</span><span style=" color:#000000;"> Operation</span><span style=" font-weight:600; color:#000000;">::</span><span style=" color:#000000;">DIV; </span><span style=" font-weight:600; color:#000000;">break</span><span style=" color:#000000;">;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    </span><span style=" font-weight:600; color:#000000;">case</span><span style=" color:#000000;"> </span><span style=" color:#dd1144;">'%'</span><span style=" color:#000000;">:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">        op </span><span style=" font-weight:600; color:#000000;">=</span><span style=" color:#000000;"> Operation</span><span style=" font-weight:600; color:#000000;">::</span><span style=" color:#000000;">MOD; </span><span style=" font-weight:600; color:#000000;">break</span><span style=" color:#000000;">;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    default:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">        op </span><span style=" font-weight:600; color:#000000;">=</span><span style=" color:#000000;"> Operation</span><span style=" font-weight:600; color:#000000;">::</span><span style=" color:#000000;">NOP; </span><span style=" font-weight:600; color:#000000;">break</span><span style=" color:#000000;">;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    }</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    </span><span style=" font-weight:600; color:#000000;">const</span><span style=" color:#000000;"> </span><span style=" font-weight:600; color:#445588;">bool</span><span style=" color:#000000;"> succeed </span><span style=" font-weight:600; color:#000000;">=</span><span style=" color:#000000;"> (op </span><span style=" font-weight:600; color:#000000;">!=</span><span style=" color:#000000;"> Operation</span><span style=" font-weight:600; color:#000000;">::</span><span style=" color:#000000;">NOP);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    </span><span style=" font-weight:600; color:#000000;">if</span><span style=" color:#000000;"> (succeed)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">        expression </span><span style=" font-weight:600; color:#000000;">=</span><span style=" color:#000000;"> remainingStr.substr(</span><span style=" color:#009999;">1</span><span style=" color:#000000;">);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    }</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    </span><span style=" font-weight:600; color:#000000;">return</span><span style=" color:#000000;"> succeed;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">}</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">Теперь можно показать, как выглядят реализации функций разбора по правилам грамматики. Не забываем о ранее запланированной замене рекурсии на цикл.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-style:italic; color:#999988;">// Parses expressions like: `a`, `a+b±...`, `a-b±...`,</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-style:italic; color:#999988;">//  where each sub-expression parsed by `ParseMulDiv`.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">Expression </span><span style=" font-weight:600; color:#000000;">*</span><span style=" font-weight:600; color:#990000;">ParseAddSub</span><span style=" color:#000000;">(std</span><span style=" font-weight:600; color:#000000;">::</span><span style=" color:#000000;">string </span><span style=" font-weight:600; color:#000000;">&amp;</span><span style=" color:#000000;">str)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">{</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    Expression </span><span style=" font-weight:600; color:#000000;">*</span><span style=" color:#000000;">left </span><span style=" font-weight:600; color:#000000;">=</span><span style=" color:#000000;"> ParseMulDiv(str);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    </span><span style=" font-weight:600; color:#000000;">while</span><span style=" color:#000000;"> (</span><span style=" color:#0086b3;">true</span><span style=" color:#000000;">)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">        Operation op </span><span style=" font-weight:600; color:#000000;">=</span><span style=" color:#000000;"> Operation</span><span style=" font-weight:600; color:#000000;">::</span><span style=" color:#000000;">NOP;</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">        </span><span style=" font-style:italic; color:#999988;">// Don't remove operator from remaining string</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">        </span><span style=" font-style:italic; color:#999988;">//  when this operator remains unhandled.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">        std</span><span style=" font-weight:600; color:#000000;">::</span><span style=" color:#000000;">string remainingStr </span><span style=" font-weight:600; color:#000000;">=</span><span style=" color:#000000;"> str;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">        </span><span style=" font-weight:600; color:#000000;">if</span><span style=" color:#000000;"> (</span><span style=" font-weight:600; color:#000000;">!</span><span style=" color:#000000;">ParseOperator(remainingStr, op)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">                </span><span style=" font-weight:600; color:#000000;">||</span><span style=" color:#000000;"> (op </span><span style=" font-weight:600; color:#000000;">!=</span><span style=" color:#000000;"> Operation</span><span style=" font-weight:600; color:#000000;">::</span><span style=" color:#000000;">ADD </span><span style=" font-weight:600; color:#000000;">&amp;&amp;</span><span style=" color:#000000;"> op </span><span style=" font-weight:600; color:#000000;">!=</span><span style=" color:#000000;"> Operation</span><span style=" font-weight:600; color:#000000;">::</span><span style=" color:#000000;">SUB))</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">        {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">            </span><span style=" font-weight:600; color:#000000;">return</span><span style=" color:#000000;"> left;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">        }</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">        str </span><span style=" font-weight:600; color:#000000;">=</span><span style=" color:#000000;"> remainingStr;</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">        Expression </span><span style=" font-weight:600; color:#000000;">*</span><span style=" color:#000000;">right </span><span style=" font-weight:600; color:#000000;">=</span><span style=" color:#000000;"> </span><span style=" color:#0086b3;">nullptr</span><span style=" color:#000000;">;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">        </span><span style=" font-weight:600; color:#000000;">try</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">        {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">            right </span><span style=" font-weight:600; color:#000000;">=</span><span style=" color:#000000;"> ParseMulDiv(str);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">        }</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">        </span><span style=" font-weight:600; color:#000000;">catch</span><span style=" color:#000000;"> (...)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">        {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">            DisposeExpression(left);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">            </span><span style=" font-weight:600; color:#000000;">throw</span><span style=" color:#000000;">;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">        }</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">        </span><span style=" font-weight:600; color:#000000;">try</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">        {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">            Expression </span><span style=" font-weight:600; color:#000000;">*</span><span style=" color:#000000;">expr </span><span style=" font-weight:600; color:#000000;">=</span><span style=" color:#000000;"> </span><span style=" font-weight:600; color:#000000;">new</span><span style=" color:#000000;"> Expression;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">            expr</span><span style=" font-weight:600; color:#000000;">-&gt;</span><span style=" color:#000000;">pLeft </span><span style=" font-weight:600; color:#000000;">=</span><span style=" color:#000000;"> left;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">            expr</span><span style=" font-weight:600; color:#000000;">-&gt;</span><span style=" color:#000000;">pRight </span><span style=" font-weight:600; color:#000000;">=</span><span style=" color:#000000;"> right;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">            expr</span><span style=" font-weight:600; color:#000000;">-&gt;</span><span style=" color:#000000;">op </span><span style=" font-weight:600; color:#000000;">=</span><span style=" color:#000000;"> op;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">            left </span><span style=" font-weight:600; color:#000000;">=</span><span style=" color:#000000;"> expr;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">        }</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">        </span><span style=" font-weight:600; color:#000000;">catch</span><span style=" color:#000000;"> (...)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">        {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">            DisposeExpression(left);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">            DisposeExpression(right);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">            </span><span style=" font-weight:600; color:#000000;">throw</span><span style=" color:#000000;">;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">        }</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    }</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    </span><span style=" font-weight:600; color:#000000;">return</span><span style=" color:#000000;"> left;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">}</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-style:italic; color:#999988;">// Parses expressions like: `a`, `a*b...`, `a/b...`, `a%b...`</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-style:italic; color:#999988;">//  where each sub-expression parsed by `ParseAtom`.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">Expression </span><span style=" font-weight:600; color:#000000;">*</span><span style=" font-weight:600; color:#990000;">ParseMulDiv</span><span style=" color:#000000;">(std</span><span style=" font-weight:600; color:#000000;">::</span><span style=" color:#000000;">string </span><span style=" font-weight:600; color:#000000;">&amp;</span><span style=" color:#000000;">str)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">{</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    Expression </span><span style=" font-weight:600; color:#000000;">*</span><span style=" color:#000000;">left </span><span style=" font-weight:600; color:#000000;">=</span><span style=" color:#000000;"> ParseAtom(str);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    </span><span style=" font-weight:600; color:#000000;">while</span><span style=" color:#000000;"> (</span><span style=" color:#0086b3;">true</span><span style=" color:#000000;">)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">        Operation op </span><span style=" font-weight:600; color:#000000;">=</span><span style=" color:#000000;"> Operation</span><span style=" font-weight:600; color:#000000;">::</span><span style=" color:#000000;">NOP;</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">        </span><span style=" font-style:italic; color:#999988;">// Don't remove operator from remaining string</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">        </span><span style=" font-style:italic; color:#999988;">//  when this operator remains unhandled.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">        std</span><span style=" font-weight:600; color:#000000;">::</span><span style=" color:#000000;">string remainingStr </span><span style=" font-weight:600; color:#000000;">=</span><span style=" color:#000000;"> str;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">        </span><span style=" font-weight:600; color:#000000;">if</span><span style=" color:#000000;"> (</span><span style=" font-weight:600; color:#000000;">!</span><span style=" color:#000000;">ParseOperator(remainingStr, op)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">                </span><span style=" font-weight:600; color:#000000;">||</span><span style=" color:#000000;"> (op </span><span style=" font-weight:600; color:#000000;">!=</span><span style=" color:#000000;"> Operation</span><span style=" font-weight:600; color:#000000;">::</span><span style=" color:#000000;">MUL </span><span style=" font-weight:600; color:#000000;">&amp;&amp;</span><span style=" color:#000000;"> op </span><span style=" font-weight:600; color:#000000;">!=</span><span style=" color:#000000;"> Operation</span><span style=" font-weight:600; color:#000000;">::</span><span style=" color:#000000;">DIV </span><span style=" font-weight:600; color:#000000;">&amp;&amp;</span><span style=" color:#000000;"> op </span><span style=" font-weight:600; color:#000000;">!=</span><span style=" color:#000000;"> Operation</span><span style=" font-weight:600; color:#000000;">::</span><span style=" color:#000000;">MOD))</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">        {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">            </span><span style=" font-weight:600; color:#000000;">return</span><span style=" color:#000000;"> left;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">        }</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">        str </span><span style=" font-weight:600; color:#000000;">=</span><span style=" color:#000000;"> remainingStr;</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">        Expression </span><span style=" font-weight:600; color:#000000;">*</span><span style=" color:#000000;">right </span><span style=" font-weight:600; color:#000000;">=</span><span style=" color:#000000;"> </span><span style=" color:#0086b3;">nullptr</span><span style=" color:#000000;">;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">        </span><span style=" font-weight:600; color:#000000;">try</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">        {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">            right </span><span style=" font-weight:600; color:#000000;">=</span><span style=" color:#000000;"> ParseAtom(str);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">        }</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">        </span><span style=" font-weight:600; color:#000000;">catch</span><span style=" color:#000000;"> (...)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">        {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">            DisposeExpression(left);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">            </span><span style=" font-weight:600; color:#000000;">throw</span><span style=" color:#000000;">;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">        }</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">        </span><span style=" font-weight:600; color:#000000;">try</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">        {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">            Expression </span><span style=" font-weight:600; color:#000000;">*</span><span style=" color:#000000;">expr </span><span style=" font-weight:600; color:#000000;">=</span><span style=" color:#000000;"> </span><span style=" font-weight:600; color:#000000;">new</span><span style=" color:#000000;"> Expression;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">            expr</span><span style=" font-weight:600; color:#000000;">-&gt;</span><span style=" color:#000000;">pLeft </span><span style=" font-weight:600; color:#000000;">=</span><span style=" color:#000000;"> left;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">            expr</span><span style=" font-weight:600; color:#000000;">-&gt;</span><span style=" color:#000000;">pRight </span><span style=" font-weight:600; color:#000000;">=</span><span style=" color:#000000;"> right;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">            expr</span><span style=" font-weight:600; color:#000000;">-&gt;</span><span style=" color:#000000;">op </span><span style=" font-weight:600; color:#000000;">=</span><span style=" color:#000000;"> op;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">            left </span><span style=" font-weight:600; color:#000000;">=</span><span style=" color:#000000;"> expr;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">        }</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">        </span><span style=" font-weight:600; color:#000000;">catch</span><span style=" color:#000000;"> (...)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">        {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">            DisposeExpression(left);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">            DisposeExpression(right);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">            </span><span style=" font-weight:600; color:#000000;">throw</span><span style=" color:#000000;">;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">        }</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    }</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    </span><span style=" font-weight:600; color:#000000;">return</span><span style=" color:#000000;"> left;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">}</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-style:italic; color:#999988;">// Parses atom expression, like a number.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">Expression </span><span style=" font-weight:600; color:#000000;">*</span><span style=" font-weight:600; color:#990000;">ParseAtom</span><span style=" color:#000000;">(std</span><span style=" font-weight:600; color:#000000;">::</span><span style=" color:#000000;">string </span><span style=" font-weight:600; color:#000000;">&amp;</span><span style=" color:#000000;">str)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">{</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    Expression </span><span style=" font-weight:600; color:#000000;">*</span><span style=" color:#000000;">expr </span><span style=" font-weight:600; color:#000000;">=</span><span style=" color:#000000;"> </span><span style=" font-weight:600; color:#000000;">new</span><span style=" color:#000000;"> Expression;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    </span><span style=" font-weight:600; color:#000000;">if</span><span style=" color:#000000;"> (</span><span style=" font-weight:600; color:#000000;">!</span><span style=" color:#000000;">ParseDouble(str, expr</span><span style=" font-weight:600; color:#000000;">-&gt;</span><span style=" color:#000000;">value))</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">        DisposeExpression(expr);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">        </span><span style=" font-weight:600; color:#000000;">throw</span><span style=" color:#000000;"> std</span><span style=" font-weight:600; color:#000000;">::</span><span style=" color:#000000;">invalid_argument(</span><span style=" color:#dd1144;">&quot;Expected number at: &quot;</span><span style=" color:#000000;"> </span><span style=" font-weight:600; color:#000000;">+</span><span style=" color:#000000;"> str);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    }</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    </span><span style=" font-weight:600; color:#000000;">return</span><span style=" color:#000000;"> expr;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">}</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<h2 align="center" style=" margin-top:32px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="wow4"></a><span style=" font-size:x-large; font-weight:600; color:#000000;">Ч</span><span style=" font-size:x-large; font-weight:600; color:#000000;">то смотреть дальше и что улучшить</span></h2>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">Другие примеры и теоретические выкладки по рекурсивному спуску есть в сети:</span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" color:#000000;" style=" margin-top:0px; margin-bottom:0px; margin-left:30px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a href="https://en.wikipedia.org/wiki/Recursive_descent_parser"><span style=" font-size:18px; text-decoration: underline; color:#2a7ae2;">Recursive descent parser (en.wikipedia.org)</span></a></li>
<li style=" color:#000000;" style=" margin-top:0px; margin-bottom:15px; margin-left:30px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a href="http://www.tutorialspoint.com/compiler_design/compiler_design_top_down_parser.htm"><span style=" font-size:18px; text-decoration: underline; color:#2a7ae2;">Compiler Design - Top-Down Parser</span></a></li></ul>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">В нашем парсере происходит множественное копирование строк в процессе разбора. Этого можно было бы избежать, если каждая рекурсивно вызываемая функция принимала бы </span><a href="http://htrd.su/wiki/zhurnal/2016/04/29/std_string_view_i_vremennye_obekty"><span style=" text-decoration: underline; color:#2a7ae2;">string_view — невладеющую ссылку на строку</span></a><span style=" color:#000000;">. Реализацию string_view можно раздобыть несколькими способами:</span></p>
<ol style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" color:#000000;" style=" margin-top:0px; margin-bottom:0px; margin-left:30px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:18px;">Найти компилятор и IDE с поддержкой C++17, в котором </span><span style=" font-size:16px;">&lt;string_view&gt;</span><span style=" font-size:18px;"> и объявленные в этом заголовке классы стали частью стандартной библиотеки</span></li>
<li style=" color:#000000;" style=" margin-top:0px; margin-bottom:0px; margin-left:30px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:18px;">Взять тривиальную реализацию на Github, состоящую из одного заголовка: </span><a href="https://github.com/sergey-shambir/string_view/blob/master/string_view.h"><span style=" font-size:18px; text-decoration: underline; color:#2a7ae2;">github.com/sergey-shambir/string_view</span></a></li>
<li style=" color:#000000;" style=" margin-top:0px; margin-bottom:15px; margin-left:30px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:18px;">Получить Boost версии 1.61 или выше, в котором есть </span><span style=" font-size:16px;">&lt;boost/utility/string_view.hpp&gt;</span></li></ol>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">По сути string_view — это удобная замена такой вот структуры для чтения строки слева направо:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600; color:#000000;">struct</span><span style=" color:#000000;"> StringScanState</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">{</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    std</span><span style=" font-weight:600; color:#000000;">::</span><span style=" color:#000000;">string text;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    </span><span style=" font-weight:600; color:#445588;">size_t</span><span style=" color:#000000;"> position;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">};</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<h2 align="center" style=" margin-top:32px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="wow5"></a><span style=" font-size:x-large; font-weight:600; color:#000000;">У</span><span style=" font-size:x-large; font-weight:600; color:#000000;">пражнения</span></h2>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">Перед кодированием составьте исправленную BNF-грамматику, чтобы спроектировать, как добавить новую возможность.</span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" color:#000000;" style=" margin-top:0px; margin-bottom:0px; margin-left:30px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:18px;">Добавьте в парсер поддержку скобок вокруг выражения. При отсутствии закрывающей скобки парсер должен выдавать какую-либо ошибку.</span></li>
<li style=" color:#000000;" style=" margin-top:0px; margin-bottom:0px; margin-left:30px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:18px;">Добавьте в парсер поддержку чтения чисел с плавающей запятой, таких как </span><span style=" font-size:16px;">124.17</span><span style=" font-size:18px;">. Для разбора вы можете использовать функцию </span><span style=" font-size:16px;">double strtod(const char *nptr, char **endptr);</span><span style=" font-size:18px;">, её полезная особенность — остановка разбора на первом недопустимом символе, с занесением адреса символа в </span><span style=" font-size:16px;">endptr</span><span style=" font-size:18px;"> (подробнее см. документацию).</span></li>
<li style=" color:#000000;" style=" margin-top:0px; margin-bottom:15px; margin-left:30px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:18px;">Добавьте в парсер поддержку унарных операторов плюс и минус. Оператор может встретиться перед любым числом, но только в одиночку, т.е. выражения вида </span><span style=" font-size:16px;">a * -1</span><span style=" font-size:18px;"> допустимы, а выражения вида </span><span style=" font-size:16px;">a + - - 2</span><span style=" font-size:18px;"> — нет.</span></li></ul>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p></body></html>