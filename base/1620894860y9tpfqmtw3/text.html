<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'DejaVu Sans'; font-size:11pt; font-weight:400; font-style:normal;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">Сердце современных фронтендов компиляторов — абстрактное синтаксическое дерево (Abstract Syntax Tree, AST). Оно создаётся на стадии синтаксического разбора, обрабатывается путём обхода при проверке семантических правил и проверке/определении типов, а затем также путём обхода AST выполняется генерация кода.</span></p>
<h1 align="center" style=" margin-top:48px; margin-bottom:14px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="зачем-нужен-ast"></a><span style=" font-size:xx-large; font-weight:600; color:#000000;">З</span><span style=" font-size:xx-large; font-weight:600; color:#000000;">ачем нужен AST</span></h1>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">AST - это Abstract Syntax Tree, то есть дерево, которое в абстрактном виде представляет структуру программы. AST создаётся парсером по мере синтаксического разбора программы. В современных компиляторах AST и список диагностик (ошибок, предупреждений) - это два результата вызова модуля синтаксического разбора.</span></p>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">AST содержит полную синтаксическую модель программы без лишних деталей (таких, как пробельные символы или комментарии). Чтобы понять, как это работает, рассмотрим, из чего состоит типичный язык программирования.</span></p>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">Типовой императивный язык программирования (такой как C, C++, PASCAL, Java, JavaScript, C#) состоит из трёх синтаксических элементов:</span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" color:#000000;" style=" margin-top:0px; margin-bottom:0px; margin-left:30px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:18px;">Выражения (expressions)</span></li>
<li style=" color:#000000;" style=" margin-top:0px; margin-bottom:0px; margin-left:30px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:18px;">Инструкции (statements)</span></li>
<li style=" color:#000000;" style=" margin-top:0px; margin-bottom:15px; margin-left:30px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:18px;">Объявления (declarations)</span></li></ul>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">AST создаётся парсером по мере синтаксического разбора программы. В современных компиляторах AST и список диагностик (ошибок, предупреждений) - это два результата вызова модуля разбора (или функции разбора).</span></p>
<h2 align="center" style=" margin-top:32px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="wow0"></a><span style=" font-size:x-large; font-weight:600; color:#000000;">В</span><span style=" font-size:x-large; font-weight:600; color:#000000;">ыражения</span></h2>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">Выражения - это выражение формулы в исходном коде. Выражение может иметь побочные эффекты: например, при вызове функции внутри выражения функция может что-то напечатать. В типичном языке программирования есть как минимум следующие типы выражений:</span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" color:#000000;" style=" margin-top:0px; margin-bottom:0px; margin-left:30px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:18px;">Доступ к переменной (variable access): например, </span><span style=" font-size:16px;">x</span></li>
<li style=" color:#000000;" style=" margin-top:0px; margin-bottom:0px; margin-left:30px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:18px;">Литерал (literal): например, </span><span style=" font-size:16px;">5.18</span><span style=" font-size:18px;"> или </span><span style=" font-size:16px;">&quot;some meaningful string&quot;</span></li>
<li style=" color:#000000;" style=" margin-top:0px; margin-bottom:0px; margin-left:30px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:18px;">Унарный оператор (unary operator): например, </span><span style=" font-size:16px;">-x</span></li>
<li style=" color:#000000;" style=" margin-top:0px; margin-bottom:0px; margin-left:30px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:18px;">Бинарный оператор (binary operator): например, </span><span style=" font-size:16px;">x + 5.18</span><span style=" font-size:18px;"> или </span><span style=" font-size:16px;">x == 5.18</span>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 2;"><li style=" color:#000000;" style=" margin-top:0px; margin-bottom:0px; margin-left:90px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:18px;">Разные бинарные операторы обычно имеют разный приоритет и могут группироваться скобками, но в функциональных языках (LISP, Haskell) операторы бывают неотличимы от функций</span></li>
<li style=" color:#000000;" style=" margin-top:0px; margin-bottom:0px; margin-left:90px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:18px;">Типовой набор операторов: арифметические, логические, сравнения; такой набор уже позволяет создавать полноценные программы</span></li></ul></li>
<li style=" color:#000000;" style=" margin-top:0px; margin-bottom:15px; margin-left:30px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:18px;">Вызов функции (function call): например, </span><span style=" font-size:16px;">sqrt(pow(a, 2.0) + pow(b, 2.0))</span></li></ul>
<h2 align="center" style=" margin-top:32px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="wow1"></a><span style=" font-size:x-large; font-weight:600; color:#000000;">И</span><span style=" font-size:x-large; font-weight:600; color:#000000;">нструкции</span></h2>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">Инструкции - это действия в исходном коде. Инструкция всегда имеет побочный эффект (печать, присваивание переменной, смена потока управления и т.д.), поэтому в некоторых языках инструкций не существует - например, в LISP или Haskell.</span></p>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">Примеры инструкций, характерных для процедурных языков:</span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" color:#000000;" style=" margin-top:0px; margin-bottom:0px; margin-left:30px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:18px;">Объявление переменной с опциональной/обязательной инициализацией, например, </span><span style=" font-size:16px;">let value = ...;</span><span style=" font-size:18px;"> или </span><span style=" font-size:16px;">int x = 500;</span>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 2;"><li style=" color:#000000;" style=" margin-top:0px; margin-bottom:0px; margin-left:90px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:18px;">В языке Python объявлений переменных нет</span></li></ul></li>
<li style=" color:#000000;" style=" margin-top:0px; margin-bottom:0px; margin-left:30px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:18px;">Присвоение переменной, например, </span><span style=" font-size:16px;">velocity = velocity + acceleration * dt;</span></li>
<li style=" color:#000000;" style=" margin-top:0px; margin-bottom:0px; margin-left:30px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:18px;">Специальные инструкции, например, печать </span><span style=" font-size:16px;">print x+1</span><span style=" font-size:18px;"> или проверка контракта </span><span style=" font-size:16px;">assert isinstance(x, int)</span><span style=" font-size:18px;"> в языке Python</span></li>
<li style=" color:#000000;" style=" margin-top:0px; margin-bottom:0px; margin-left:30px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:18px;">Условные инструкции, такие как </span><span style=" font-size:16px;">if</span><span style=" font-size:18px;">, </span><span style=" font-size:16px;">switch</span></li>
<li style=" color:#000000;" style=" margin-top:0px; margin-bottom:0px; margin-left:30px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:18px;">Циклы, такие как </span><span style=" font-size:16px;">while</span><span style=" font-size:18px;">, </span><span style=" font-size:16px;">do/while</span><span style=" font-size:18px;">, </span><span style=" font-size:16px;">repeat/until</span><span style=" font-size:18px;">, </span><span style=" font-size:16px;">for</span><span style=" font-size:18px;">, </span><span style=" font-size:16px;">foreach</span></li>
<li style=" color:#000000;" style=" margin-top:0px; margin-bottom:0px; margin-left:30px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:18px;">Инструкции потока управления, например, возвраты из функций </span><span style=" font-size:16px;">return x+5;</span><span style=" font-size:18px;"> или прерывания циклов </span><span style=" font-size:16px;">break;</span>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 2;"><li style=" color:#000000;" style=" margin-top:0px; margin-bottom:0px; margin-left:90px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:18px;">Возвраты требуются не во всех языках - иногда функция просто возвращает последнее вычисленное выражение</span></li></ul></li>
<li style=" color:#000000;" style=" margin-top:0px; margin-bottom:15px; margin-left:30px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:18px;">Блоки кода, такие как </span><span style=" font-size:16px;">{ doA(); doB(); return 5; }</span></li></ul>
<h2 align="center" style=" margin-top:32px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="wow2"></a><span style=" font-size:x-large; font-weight:600; color:#000000;">О</span><span style=" font-size:x-large; font-weight:600; color:#000000;">бъявление</span></h2>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">Объявление - это создание новой именованной сущности, такой как функция или тип. Объявления типов бывают разнообразными: различные языки могут позволять объявлять новый тип как синоним старого типа, как структуру, как класс, как интерфейс или иным образом.</span></p>
<h2 align="center" style=" margin-top:32px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="wow3"></a><span style=" font-size:x-large; font-weight:600; color:#000000;">С</span><span style=" font-size:x-large; font-weight:600; color:#000000;">порные вопросы</span></h2>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">Некоторые сущности трудно отнести к той или иной категории. Например:</span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" color:#000000;" style=" margin-top:0px; margin-bottom:0px; margin-left:30px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:18px;">Объявление анонимной функции (лямбды) можно считать объявлением без имени либо выражением</span></li>
<li style=" color:#000000;" style=" margin-top:0px; margin-bottom:15px; margin-left:30px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:18px;">Объявление переменной можно считать как просто инструкцией, так и полноценным объявлением</span></li></ul>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">Спорные вопросы обычно решаются в сторону удобства для создателя языка или компилятора.</span></p>
<h1 align="center" style=" margin-top:48px; margin-bottom:14px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="что-такое-ast"></a><span style=" font-size:xx-large; font-weight:600; color:#000000;">Ч</span><span style=" font-size:xx-large; font-weight:600; color:#000000;">то такое AST?</span></h1>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">AST - это Abstract Syntax Tree, т.е. представление структуры программы в виде дерева объявлений, инструкций и выражений.</span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" color:#000000;" style=" margin-top:0px; margin-bottom:0px; margin-left:30px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:18px;">AST не является бинарным деревом: например, у унарного оператора будет один дочерний узел</span></li>
<li style=" color:#000000;" style=" margin-top:0px; margin-bottom:0px; margin-left:30px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:18px;">AST является гетерогенным деревом, состоящим из узлов разного типа</span>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 2;"><li style=" color:#000000;" style=" margin-top:0px; margin-bottom:0px; margin-left:90px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:18px;">В этом AST похож на DOM-представление документа HTML/XML</span></li></ul></li>
<li style=" color:#000000;" style=" margin-top:0px; margin-bottom:15px; margin-left:30px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:18px;">В каждом поддереве дочерними узлами становятся лексически вложенные сущности: например, для узла объявления функции дочерними узлами являются инструкции, составляющие тело функции, а также объявления параметров функции (если они выделены в отдельные узлы AST волей автора компилятора)</span></li></ul>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">Удобный способ реализовать AST в коде - это иерархия классов и интерфейсов. Например, можно ввести три базовых интерфейса:</span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" color:#000000;" style=" margin-top:0px; margin-bottom:0px; margin-left:30px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:16px;">ExpressionAST</span><span style=" font-size:18px;"> - интерфейс, который реализуется всеми выражениями</span></li>
<li style=" color:#000000;" style=" margin-top:0px; margin-bottom:0px; margin-left:30px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:16px;">StatementAST</span><span style=" font-size:18px;"> - интерфейс, который реализуется всеми инструкциями</span></li>
<li style=" color:#000000;" style=" margin-top:0px; margin-bottom:15px; margin-left:30px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:16px;">DeclarationAST</span><span style=" font-size:18px;"> - аналогичный интерфейс для объявлений функций и типов</span>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 2;"><li style=" color:#000000;" style=" margin-top:0px; margin-bottom:0px; margin-left:90px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:18px;">В компилируемых языках всю программу целиком можно считать списком </span><span style=" font-size:16px;">DeclarationAST</span><span style=" font-size:18px;">, в скриптовых - списком </span><span style=" font-size:16px;">StatementAST</span></li>
<li style=" color:#000000;" style=" margin-top:0px; margin-bottom:0px; margin-left:90px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:18px;">Альтернативно, можно ввести специальный узел </span><span style=" font-size:16px;">ProgramAST</span><span style=" font-size:18px;"> или </span><span style=" font-size:16px;">ModuleAST</span></li></ul></li></ul>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">Если в языке нет типов, то DeclarationAST можно для удобства превратить в FunctionAST и считать программу списком FunctionAST.</span></p>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">Все остальные классы из иерархии наследуются от базовых интерфейсов и реализуют объявленные ими методы. Какие методы находятся в базовых интерфейсах - решать автору компилятора/интерпретатора. В любом случае, методы должны выстраиваться в единую модель генерации кода или интерпретации.</span></p>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">Суть дерева - в возможности обойти его (слева направо в глубину или другим способом). При обходе можно выполнять осмысленные действия, при этом возникает </span><span style=" font-style:italic; color:#000000;">проблема двойной диспетчеризации</span><span style=" color:#000000;">: мы должны выбирать действие в зависимости как от алгоритма, которым мы обрабатываем дерево, так и от типа узла дерева, который мы сейчас обходим. Рассмотрим пути решения проблемы:</span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" color:#000000;" style=" margin-top:0px; margin-bottom:0px; margin-left:30px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:18px;">Можно избежать проблемы: например, добавляем полиморфный метод </span><span style=" font-size:16px;">Evaluate</span><span style=" font-size:18px;"> в интерфейс </span><span style=" font-size:16px;">ExpressionAST</span><span style=" font-size:18px;"> и реализуем его по-разному в классах </span><span style=" font-size:16px;">LiteralAST</span><span style=" font-size:18px;">, </span><span style=" font-size:16px;">VariableAST</span><span style=" font-size:18px;">, </span><span style=" font-size:16px;">BinaryOperatorAST</span><span style=" font-size:18px;">, </span><span style=" font-size:16px;">CallAST</span><span style=" font-size:18px;"> - на выходе получаем возможность вычислить выражение</span></li>
<li style=" color:#000000;" style=" margin-top:0px; margin-bottom:0px; margin-left:30px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:18px;">Можно решить проблему с помощью шаблона проектирования Visitor (Посетитель)</span></li>
<li style=" color:#000000;" style=" margin-top:0px; margin-bottom:15px; margin-left:30px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:18px;">Можно решить проблему с помощью сопоставления шаблона (pattern matching) по типу, если язык это поддерживает</span>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 2;"><li style=" color:#000000;" style=" margin-top:0px; margin-bottom:0px; margin-left:90px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:18px;">Например, в </span><span style=" font-size:16px;">Go</span><span style=" font-size:18px;"> можно использовать </span><a href="https://yourbasic.org/golang/type-assertion-switch/"><span style=" font-size:18px; text-decoration: underline; color:#2a7ae2;">type switch</span></a></li>
<li style=" color:#000000;" style=" margin-top:0px; margin-bottom:0px; margin-left:90px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:18px;">В C++ можно было бы использовать </span><span style=" font-size:16px;">std::variant</span><span style=" font-size:18px;">, но он не поддерживает рекурсию в собственном определении</span></li></ul></li></ul>
<h1 align="center" style=" margin-top:48px; margin-bottom:14px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="конструирование-ast-в-парсере"></a><span style=" font-size:xx-large; font-weight:600; color:#000000;">К</span><span style=" font-size:xx-large; font-weight:600; color:#000000;">онструирование AST в парсере</span></h1>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">Для конструирования узлов AST потребуется выделять память, а затем запоминать указатель в стеке парсера. Напомним, что любой реальный язык содержит рекурсивные синтаксические правила (например, выражения всегда определяются рекурсивно), значит, парсер языка не может быть реализован без стека или без рекурсии (которая эквивалентна стеку). Поэтому способ работы с AST зависит от метода создания парсера.</span></p>
<h2 align="center" style=" margin-top:32px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="wow4"></a><span style=" font-size:x-large; font-weight:600; color:#000000;">Р</span><span style=" font-size:x-large; font-weight:600; color:#000000;">екурсивный спуск</span></h2>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">Если вы используете рекурсивный спуск, то вы скорее всего</span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" color:#000000;" style=" margin-top:0px; margin-bottom:0px; margin-left:30px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:18px;">Пишете по одной функции/методу парсинга на каждое правило формальной грамматики: например, методы </span><span style=" font-size:16px;">Parser::parseExpr</span><span style=" font-size:18px;">, </span><span style=" font-size:16px;">Parser::parseCallExpr</span><span style=" font-size:18px;">, </span><span style=" font-size:16px;">Parser::parseAssignment</span></li>
<li style=" color:#000000;" style=" margin-top:0px; margin-bottom:15px; margin-left:30px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:18px;">В случае ошибки разбора бросаете исключение или добавляете объект, описывающий ошибку, в возвращаемое значение каждой функции парсера</span></li></ul>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">Таким образом, типичная функция парсинга выглядит примерно так:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600; color:#445588;">bool</span><span style=" color:#000000;"> Parser</span><span style=" font-weight:600; color:#000000;">::</span><span style=" color:#000000;">parseExpr()</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">{</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    </span><span style=" font-style:italic; color:#999988;">// Если следующий токен - ID, то это вызов функции или обращение к переменной</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    </span><span style=" font-weight:600; color:#000000;">if</span><span style=" color:#000000;"> (NextToken().type </span><span style=" font-weight:600; color:#000000;">==</span><span style=" color:#000000;"> Token.ID)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">        </span><span style=" font-weight:600; color:#000000;">if</span><span style=" color:#000000;"> (NextToken(</span><span style=" color:#009999;">2</span><span style=" color:#000000;">).type </span><span style=" font-weight:600; color:#000000;">==</span><span style=" color:#000000;"> Token.OpenParen)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">        {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">            </span><span style=" font-weight:600; color:#000000;">return</span><span style=" color:#000000;"> parseCallExpr();</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">        }</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">        </span><span style=" font-weight:600; color:#000000;">return</span><span style=" color:#000000;"> parseVariableAccess();</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    }</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    </span><span style=" font-style:italic; color:#999988;">// ... разбираем иные варианты ...</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-style:italic; color:#999988;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    </span><span style=" font-style:italic; color:#999988;">// Ожидалось выражение, но его нет</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    </span><span style=" font-weight:600; color:#000000;">throw</span><span style=" color:#000000;"> ParseException(</span><span style=" color:#dd1144;">&quot;expected expression, got &quot;</span><span style=" color:#000000;"> </span><span style=" font-weight:600; color:#000000;">+</span><span style=" color:#000000;"> NextToken().ToString(), NextToken());</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">}</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">Для добавления конструирования AST следуйте простым правилам:</span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" color:#000000;" style=" margin-top:0px; margin-bottom:0px; margin-left:30px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:18px;">на каждое правило грамматики создавайте узлы AST с помощью оператора </span><span style=" font-size:16px;">new</span><span style=" font-size:18px;">, а в языке C++ - с помощью </span><span style=" font-size:16px;">std::make_unique</span></li>
<li style=" color:#000000;" style=" margin-top:0px; margin-bottom:0px; margin-left:30px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:18px;">сохраняйте указатели на узлы в локальные переменные</span></li>
<li style=" color:#000000;" style=" margin-top:0px; margin-bottom:15px; margin-left:30px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:18px;">возвращайте из каждой функции парсинга указатель на узел AST, полученный при разборе по соответствующему правилу грамматики</span>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 2;"><li style=" color:#000000;" style=" margin-top:0px; margin-bottom:0px; margin-left:90px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:18px;">в случае ошибки - бросайте исключение</span></li></ul></li></ul>
<h2 align="center" style=" margin-top:32px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="wow5"></a><span style=" font-size:x-large; font-weight:600; color:#000000;">В</span><span style=" font-size:x-large; font-weight:600; color:#000000;">осходящий разбор методом свёртки (LL, LR, SLR, LALR)</span></h2>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">Если вы используете табличный недетерминированный конечный автомат со стеком для </span><a href="https://ps-group.github.io/compilers/shift_reduce"><span style=" text-decoration: underline; color:#2a7ae2;">восходящего разбора методом свёртки</span></a><span style=" color:#000000;">, то вы можете следовать нескольким правилам:</span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" color:#000000;" style=" margin-top:0px; margin-bottom:0px; margin-left:30px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:18px;">добавляйте действия по созданию AST в список действий при свёртке в рамках атрибутивной грамматики</span></li>
<li style=" color:#000000;" style=" margin-top:0px; margin-bottom:0px; margin-left:30px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:18px;">на каждое правило грамматики создавайте узлы AST с помощью оператора </span><span style=" font-size:16px;">new</span></li>
<li style=" color:#000000;" style=" margin-top:0px; margin-bottom:0px; margin-left:30px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:18px;">сохраняйте указатели на узлы в ячейку стека парсера, соответствующую результату свёртки текущего правила</span></li>
<li style=" color:#000000;" style=" margin-top:0px; margin-bottom:15px; margin-left:30px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:18px;">извлекайте из соответствующих ячеек стека результаты свёртки предыдущих правил</span></li></ul>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">Пример декларативного описания правила грамматики с конструированием AST (для генератора парсеров Lemon):</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">statement </span><span style=" font-weight:600; color:#000000;">::=</span><span style=" color:#000000;"> PRINT expression(A).</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">{</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    </span><span style=" font-weight:600; color:#000000;">auto</span><span style=" color:#000000;"> stmt </span><span style=" font-weight:600; color:#000000;">=</span><span style=" color:#000000;"> pParse</span><span style=" font-weight:600; color:#000000;">-&gt;</span><span style=" color:#000000;">MakeAST</span><span style=" font-weight:600; color:#000000;">&lt;</span><span style=" color:#000000;">CPrintAst</span><span style=" font-weight:600; color:#000000;">&gt;</span><span style=" color:#000000;">(A.expr);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    pParse</span><span style=" font-weight:600; color:#000000;">-&gt;</span><span style=" color:#000000;">AddStatement(stmt);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">}</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<h1 align="center" style=" margin-top:48px; margin-bottom:14px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="обработка-готового-ast"></a><span style=" font-size:xx-large; font-weight:600; color:#000000;">О</span><span style=" font-size:xx-large; font-weight:600; color:#000000;">бработка готового AST</span></h1>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">Путём обработки готового AST можно</span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" color:#000000;" style=" margin-top:0px; margin-bottom:0px; margin-left:30px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:18px;">во фронтенде компилятора или интерпретатора: проверять семантические правила языка</span></li>
<li style=" color:#000000;" style=" margin-top:0px; margin-bottom:0px; margin-left:30px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:18px;">в компиляторе: выполнять генерацию промежуточного или машинного кода</span></li>
<li style=" color:#000000;" style=" margin-top:0px; margin-bottom:0px; margin-left:30px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:18px;">в компиляторе или интерпретаторе: генерировать код виртуальной машины</span></li>
<li style=" color:#000000;" style=" margin-top:0px; margin-bottom:0px; margin-left:30px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:18px;">в интерпретаторе: выполнять программу непосредственно</span></li>
<li style=" color:#000000;" style=" margin-top:0px; margin-bottom:15px; margin-left:30px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:18px;">для отладки: печатать AST, полученный из парсера</span></li></ul>
<h2 align="center" style=" margin-top:32px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="wow6"></a><span style=" font-size:x-large; font-weight:600; color:#000000;">С</span><span style=" font-size:x-large; font-weight:600; color:#000000;">пособы обхода AST</span></h2>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">В глубину слева направо</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600; color:#000000;">function</span><span style=" color:#000000;"> visit(node) {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    actionBeforeVisit(node)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    </span><span style=" font-weight:600; color:#000000;">for</span><span style=" color:#000000;"> child </span><span style=" font-weight:600; color:#000000;">in</span><span style=" color:#000000;"> node.children()</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">        child.accept(</span><span style=" font-weight:600; color:#000000;">this</span><span style=" color:#000000;">)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    actionAfterVisit(node)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">}</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">В глубину справа налево</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600; color:#000000;">function</span><span style=" color:#000000;"> visit(node) {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    actionBeforeVisit(node)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    </span><span style=" font-weight:600; color:#000000;">for</span><span style=" color:#000000;"> child </span><span style=" font-weight:600; color:#000000;">in</span><span style=" color:#000000;"> reverse(node.children())</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">        child.accept(</span><span style=" font-weight:600; color:#000000;">this</span><span style=" color:#000000;">)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    actionAfterVisit(node)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">}</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">В ширину слева направо (влечёт значительный расход памяти):</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600; color:#000000;">function</span><span style=" color:#000000;"> visit(node_list) {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    new_node_list </span><span style=" font-weight:600; color:#000000;">=</span><span style=" color:#000000;"> []</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    </span><span style=" font-weight:600; color:#000000;">for</span><span style=" color:#000000;"> node </span><span style=" font-weight:600; color:#000000;">in</span><span style=" color:#000000;"> node_list {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">        actionOnVisit(node)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">        </span><span style=" font-weight:600; color:#000000;">for</span><span style=" color:#000000;"> child </span><span style=" font-weight:600; color:#000000;">in</span><span style=" color:#000000;"> node.children()</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">            new_node_list </span><span style=" font-weight:600; color:#000000;">&lt;&lt;</span><span style=" color:#000000;"> child</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    }</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    visit(new_node_list)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">}</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">В ширину справа налево (влечёт значительный расход памяти).</span></p>
<h2 align="center" style=" margin-top:32px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="wow7"></a><span style=" font-size:x-large; font-weight:600; color:#000000;">E</span><span style=" font-size:x-large; font-weight:600; color:#000000;">xpression problem</span></h2>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" color:#000000;" style=" margin-top:0px; margin-bottom:0px; margin-left:30px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:18px;">проблема: как реализовать гибкое добавление типов и операций в некотором языке программирования?</span></li>
<li style=" color:#000000;" style=" margin-top:0px; margin-bottom:15px; margin-left:30px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:18px;">типовые решения реализуют двойную диспетчеризацию: выбор ветви исполнения кода в зависимости и от типа, и от операции</span></li></ul>
<h2 align="center" style=" margin-top:32px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="wow8"></a><span style=" font-size:x-large; font-weight:600; color:#000000;">Р</span><span style=" font-size:x-large; font-weight:600; color:#000000;">ешение 1: case-распознавание</span></h2>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">Подходит для процедурных и функциональных языков. Варианты: if/elseif/else, switch/case или pattern matching.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-style:italic; color:#999988;">// Печатает поддерево, начиная с узла node</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600; color:#000000;">function</span><span style=" color:#000000;"> print(node) {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">  </span><span style=" font-weight:600; color:#000000;">case</span><span style=" color:#000000;"> node </span><span style=" font-weight:600; color:#000000;">of</span><span style=" color:#000000;"> {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    AddOperator </span><span style=" font-weight:600; color:#000000;">=&gt;</span><span style=" color:#000000;"> print(node.left) </span><span style=" font-weight:600; color:#000000;">+</span><span style=" color:#000000;"> </span><span style=" color:#dd1144;">'+'</span><span style=" color:#000000;"> </span><span style=" font-weight:600; color:#000000;">+</span><span style=" color:#000000;"> print(node.right)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    NotOperator </span><span style=" font-weight:600; color:#000000;">=&gt;</span><span style=" color:#000000;"> </span><span style=" color:#dd1144;">'!'</span><span style=" color:#000000;"> </span><span style=" font-weight:600; color:#000000;">+</span><span style=" color:#000000;"> print(node)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    Variable    </span><span style=" font-weight:600; color:#000000;">=&gt;</span><span style=" color:#000000;"> print(variables.</span><span style=" font-weight:600; color:#000000;">get</span><span style=" color:#000000;">(node.name).value)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    Literal     </span><span style=" font-weight:600; color:#000000;">=&gt;</span><span style=" color:#000000;"> print(node.value)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">  }</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">}</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-style:italic; color:#999988;">// Вычисляет значение, начиная с узла node</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600; color:#000000;">function</span><span style=" color:#000000;"> </span><span style=" font-weight:600; color:#000000;">eval</span><span style=" color:#000000;">(node) {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">  </span><span style=" font-weight:600; color:#000000;">case</span><span style=" color:#000000;"> node </span><span style=" font-weight:600; color:#000000;">of</span><span style=" color:#000000;"> {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    AddOperator </span><span style=" font-weight:600; color:#000000;">=&gt;</span><span style=" color:#000000;"> </span><span style=" font-weight:600; color:#000000;">return</span><span style=" color:#000000;"> </span><span style=" font-weight:600; color:#000000;">eval</span><span style=" color:#000000;">(node.left) </span><span style=" font-weight:600; color:#000000;">+</span><span style=" color:#000000;"> </span><span style=" font-weight:600; color:#000000;">eval</span><span style=" color:#000000;">(node.right)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    NotOperator </span><span style=" font-weight:600; color:#000000;">=&gt;</span><span style=" color:#000000;"> </span><span style=" font-weight:600; color:#000000;">return</span><span style=" color:#000000;"> </span><span style=" font-weight:600; color:#000000;">!eval</span><span style=" color:#000000;">(node)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    Variable    </span><span style=" font-weight:600; color:#000000;">=&gt;</span><span style=" color:#000000;"> </span><span style=" font-weight:600; color:#000000;">return</span><span style=" color:#000000;"> variables.</span><span style=" font-weight:600; color:#000000;">get</span><span style=" color:#000000;">(node.name).value</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    Literal     </span><span style=" font-weight:600; color:#000000;">=&gt;</span><span style=" color:#000000;"> </span><span style=" font-weight:600; color:#000000;">return</span><span style=" color:#000000;"> node.value</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">  }</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">}</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<h2 align="center" style=" margin-top:32px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="wow9"></a><span style=" font-size:x-large; font-weight:600; color:#000000;">Р</span><span style=" font-size:x-large; font-weight:600; color:#000000;">ешение 2: полиморфные методы</span></h2>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">Подходит для объектно-ориентированных и некоторых функциональных языков. В языке должно быть наследование либо утиная типизация, а также иерархия классов.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600; color:#000000;">class</span><span style=" color:#000000;"> AddOperator </span><span style=" font-weight:600; color:#000000;">extends</span><span style=" color:#000000;"> Node {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">  </span><span style=" font-weight:600; color:#000000;">let</span><span style=" color:#000000;"> left: Node </span><span style=" font-weight:600; color:#000000;">=</span><span style=" color:#000000;"> </span><span style=" font-weight:600; color:#000000;">null</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">  </span><span style=" font-weight:600; color:#000000;">let</span><span style=" color:#000000;"> right: Node </span><span style=" font-weight:600; color:#000000;">=</span><span style=" color:#000000;"> </span><span style=" font-weight:600; color:#000000;">null</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-weight:600; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">  </span><span style=" font-weight:600; color:#000000;">function</span><span style=" color:#000000;"> print() {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    left.print()</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    print(</span><span style=" color:#dd1144;">' + '</span><span style=" color:#000000;">)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    right.print()</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">  }</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">  </span><span style=" font-weight:600; color:#000000;">function</span><span style=" color:#000000;"> </span><span style=" font-weight:600; color:#000000;">eval</span><span style=" color:#000000;">() {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    </span><span style=" font-weight:600; color:#000000;">return</span><span style=" color:#000000;"> left.</span><span style=" font-weight:600; color:#000000;">eval</span><span style=" color:#000000;">() </span><span style=" font-weight:600; color:#000000;">+</span><span style=" color:#000000;"> right.</span><span style=" font-weight:600; color:#000000;">eval</span><span style=" color:#000000;">()</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">  }</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">}</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600; color:#000000;">class</span><span style=" color:#000000;"> NotOperator </span><span style=" font-weight:600; color:#000000;">extends</span><span style=" color:#000000;"> Node {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">  </span><span style=" font-weight:600; color:#000000;">let</span><span style=" color:#000000;"> child: Node </span><span style=" font-weight:600; color:#000000;">=</span><span style=" color:#000000;"> </span><span style=" font-weight:600; color:#000000;">null</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-weight:600; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">  </span><span style=" font-weight:600; color:#000000;">function</span><span style=" color:#000000;"> print() {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    print(</span><span style=" color:#dd1144;">'!'</span><span style=" color:#000000;">)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    child.print()</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">  }</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">  </span><span style=" font-weight:600; color:#000000;">function</span><span style=" color:#000000;"> </span><span style=" font-weight:600; color:#000000;">eval</span><span style=" color:#000000;">() {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    </span><span style=" font-weight:600; color:#000000;">return</span><span style=" color:#000000;"> not child.</span><span style=" font-weight:600; color:#000000;">eval</span><span style=" color:#000000;">()</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">  }</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">}</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<h2 align="center" style=" margin-top:32px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="wow10"></a><span style=" font-size:x-large; font-weight:600; color:#000000;">Р</span><span style=" font-size:x-large; font-weight:600; color:#000000;">ешение 3: Visitor (Посетитель)</span></h2>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">Объектно-ориентированные языки не имеют встроенного решения, но зато есть паттерн проектирования Visitor (Посетитель).</span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" color:#000000;" style=" margin-top:0px; margin-bottom:15px; margin-left:30px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:18px;">отношения классов и методов повёрнуты на 90°: новые операции становятся классами, тип данных с точки зрения операции (PrintVisitor, EvaluationVisitor) определяется методами (visitAddOperator, visitNotOperator или просто перегруженный/шаблонный visit)</span></li></ul>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">Реализовать паттерн Visitor в C++ можно с помощью полиморфизма (virtual-методы и классы) или с помощью шаблонов (Curiously recurring template pattern).</span></p>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">Реализация на виртуальных методах:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600; color:#000000;">struct</span><span style=" color:#000000;"> VaribleAst;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600; color:#000000;">struct</span><span style=" color:#000000;"> LiteralAst;</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600; color:#000000;">struct</span><span style=" color:#000000;"> IVisitor</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">{</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    </span><span style=" font-weight:600; color:#000000;">virtual</span><span style=" color:#000000;"> </span><span style=" font-weight:600; color:#000000;">~</span><span style=" color:#000000;">IVisitor() </span><span style=" font-weight:600; color:#000000;">=</span><span style=" color:#000000;"> </span><span style=" font-weight:600; color:#000000;">default</span><span style=" color:#000000;">;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    </span><span style=" font-weight:600; color:#000000;">virtual</span><span style=" color:#000000;"> </span><span style=" font-weight:600; color:#445588;">void</span><span style=" color:#000000;"> visit(VaribleAst </span><span style=" font-weight:600; color:#000000;">&amp;</span><span style=" color:#000000;">ast) </span><span style=" font-weight:600; color:#000000;">=</span><span style=" color:#000000;"> </span><span style=" color:#009999;">0</span><span style=" color:#000000;">;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    </span><span style=" font-weight:600; color:#000000;">virtual</span><span style=" color:#000000;"> </span><span style=" font-weight:600; color:#445588;">void</span><span style=" color:#000000;"> visit(LiteralAst </span><span style=" font-weight:600; color:#000000;">&amp;</span><span style=" color:#000000;">ast) </span><span style=" font-weight:600; color:#000000;">=</span><span style=" color:#000000;"> </span><span style=" color:#009999;">0</span><span style=" color:#000000;">;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">};</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600; color:#000000;">struct</span><span style=" color:#000000;"> IExpressionAst</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">{</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    </span><span style=" font-weight:600; color:#000000;">virtual</span><span style=" color:#000000;"> </span><span style=" font-weight:600; color:#000000;">~</span><span style=" color:#000000;">IExpressionAst() </span><span style=" font-weight:600; color:#000000;">=</span><span style=" color:#000000;"> </span><span style=" font-weight:600; color:#000000;">default</span><span style=" color:#000000;">;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    </span><span style=" font-weight:600; color:#000000;">virtual</span><span style=" color:#000000;"> </span><span style=" font-weight:600; color:#445588;">void</span><span style=" color:#000000;"> accept(IVisitor </span><span style=" font-weight:600; color:#000000;">&amp;</span><span style=" color:#000000;">visitor) </span><span style=" font-weight:600; color:#000000;">=</span><span style=" color:#000000;"> </span><span style=" color:#009999;">0</span><span style=" color:#000000;">;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">}</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600; color:#000000;">struct</span><span style=" color:#000000;"> VariableAst </span><span style=" font-weight:600; color:#000000;">:</span><span style=" color:#000000;"> IExpressionAst</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">{</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    </span><span style=" font-weight:600; color:#445588;">void</span><span style=" color:#000000;"> accept(IVisitor </span><span style=" font-weight:600; color:#000000;">&amp;</span><span style=" color:#000000;">visitor) </span><span style=" font-weight:600; color:#000000;">override</span><span style=" color:#000000;"> {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">        visitor.visit(</span><span style=" font-weight:600; color:#000000;">*this</span><span style=" color:#000000;">);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    }</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">}</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600; color:#000000;">struct</span><span style=" color:#000000;"> LiteralAst </span><span style=" font-weight:600; color:#000000;">:</span><span style=" color:#000000;"> IExpressionAst</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">{</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    </span><span style=" font-weight:600; color:#445588;">void</span><span style=" color:#000000;"> accept(IVisitor </span><span style=" font-weight:600; color:#000000;">&amp;</span><span style=" color:#000000;">visitor) </span><span style=" font-weight:600; color:#000000;">override</span><span style=" color:#000000;"> {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">        visitor.visit(</span><span style=" font-weight:600; color:#000000;">*this</span><span style=" color:#000000;">);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    }</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">}</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">Реализация на CRTP (Curiously recurring template pattern), которую не рекомендуется использовать из-за бессмысленной сложности:</span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" color:#000000;" style=" margin-top:0px; margin-bottom:0px; margin-left:30px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a href="https://gist.github.com/matovitch/5dfdac845b159b6a0a8e"><span style=" font-size:18px; text-decoration: underline; color:#2a7ae2;">шаблоны Visitor и Visitable</span></a></li>
<li style=" color:#000000;" style=" margin-top:0px; margin-bottom:15px; margin-left:30px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a href="https://gist.github.com/matovitch/3dad7e9092dec9427c79"><span style=" font-size:18px; text-decoration: underline; color:#2a7ae2;">пример использования</span></a></li></ul>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">Объектно-ориентированный подход не снимает Expression Problem, но позволяет выбирать, что будет простым: добавление новых типов данных или новых операций</span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" color:#000000;" style=" margin-top:0px; margin-bottom:0px; margin-left:30px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:18px;">если AST создан без паттерна Visitor (решение №2), проще будет добавлять новые типы данных;</span></li>
<li style=" color:#000000;" style=" margin-top:0px; margin-bottom:15px; margin-left:30px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:18px;">если AST создан с паттерном Visitor (решение №3), проще будет добавлять новые операции</span></li></ul>
<h2 align="center" style=" margin-top:32px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="wow11"></a><span style=" font-size:x-large; font-weight:600; color:#000000;">Р</span><span style=" font-size:x-large; font-weight:600; color:#000000;">ешение 4: Обход дерева и case-распознавание</span></h2>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">Псевдокод:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600; color:#000000;">function</span><span style=" color:#000000;"> (</span><span style=" font-weight:600; color:#000000;">this</span><span style=" color:#000000;"> </span><span style=" font-weight:600; color:#000000;">*</span><span style=" color:#000000;">EvaluationVisitor) visit(node) {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">  </span><span style=" font-weight:600; color:#000000;">case</span><span style=" color:#000000;"> node </span><span style=" font-weight:600; color:#000000;">of</span><span style=" color:#000000;">:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    AddOperator </span><span style=" font-weight:600; color:#000000;">=&gt;</span><span style=" color:#000000;"> print(node.left) </span><span style=" font-weight:600; color:#000000;">+</span><span style=" color:#000000;"> </span><span style=" color:#dd1144;">'+'</span><span style=" color:#000000;"> </span><span style=" font-weight:600; color:#000000;">+</span><span style=" color:#000000;"> print(node.right)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">    NotOperator </span><span style=" font-weight:600; color:#000000;">=&gt;</span><span style=" color:#000000;"> </span><span style=" color:#dd1144;">'!'</span><span style=" color:#000000;"> </span><span style=" font-weight:600; color:#000000;">+</span><span style=" color:#000000;"> print(node)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">}</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600; color:#000000;">function</span><span style=" color:#000000;"> </span><span style=" font-weight:600; color:#000000;">eval</span><span style=" color:#000000;">(ast) {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">  </span><span style=" font-weight:600; color:#000000;">var</span><span style=" color:#000000;"> visitor EvaluationVisitor</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">  ast.walk(visitor)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">}</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" color:#000000;" style=" margin-top:0px; margin-bottom:0px; margin-left:30px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:18px;">Решение хорошо работает в языках с поддержкой ООП и pattern matching, таких как Golang.</span></li>
<li style=" color:#000000;" style=" margin-top:0px; margin-bottom:0px; margin-left:30px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a href="https://github.com/sergey-shambir/gosemki/blob/master/src/gosemki/CallExprVisitor.go"><span style=" font-size:18px; text-decoration: underline; color:#2a7ae2;">Пример для Golang (github.com)</span></a></li>
<li style=" color:#000000;" style=" margin-top:0px; margin-bottom:15px; margin-left:30px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:18px;">В C++ 2011 можно сделать pattern matching на уровне библиотеки: </span><a href="https://github.com/solodon4/Mach7"><span style=" font-size:18px; text-decoration: underline; color:#2a7ae2;">библиотека Mach7 (github.com)</span></a></li></ul>
<h2 align="center" style=" margin-top:32px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="wow12"></a><span style=" font-size:x-large; font-weight:600; color:#000000;">С</span><span style=" font-size:x-large; font-weight:600; color:#000000;">емантическая постобработка дерева</span></h2>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">Семантическая постобработка дерева позволяет добавить в язык правила, выходящие за рамки контекстно-свободных грамматик.</span></p>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">Например, путём постобработки можно:</span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" color:#000000;" style=" margin-top:0px; margin-bottom:0px; margin-left:30px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:18px;">проверить корректность всех выражений с точки зрения типов</span></li>
<li style=" color:#000000;" style=" margin-top:0px; margin-bottom:0px; margin-left:30px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:18px;">добавить в язык возможность размещать вызов функции до её объявления в исходном коде (как в языке JavaScript)</span></li>
<li style=" color:#000000;" style=" margin-top:0px; margin-bottom:15px; margin-left:30px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:18px;">проверить корректность использования </span><span style=" font-size:16px;">break;</span><span style=" font-size:18px;"> и </span><span style=" font-size:16px;">continue;</span><span style=" font-size:18px;"> - должны использоваться только внутри циклов</span></li></ul>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">Подобные шаги постобработки дерева называются “процедурами семантической проверки”, их часто выделяют в собственный модуль - модуль семантики языка.</span></p>
<h2 align="center" style=" margin-top:32px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="wow13"></a><span style=" font-size:x-large; font-weight:600; color:#000000;">Г</span><span style=" font-size:x-large; font-weight:600; color:#000000;">енерация кода по AST</span></h2>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">О методах генерации кода на базе собранного AST вы можете прочитать в статье </span><a href="https://ps-group.github.io/compilers/stack_and_register"><span style=" text-decoration: underline; color:#2a7ae2;">Стековые и регистровые машины</span></a><span style=" color:#000000;">.</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p></body></html>