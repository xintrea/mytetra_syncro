<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'DejaVu Sans'; font-size:11pt; font-weight:400; font-style:normal;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Arduino - это прежде всего, кроссплатформенный фреймворк для программирования микроконтроллеров. Он позволяет писать программы, которые смогут выполняться на основных современных распространенных архитектурах микроконтроллеров, включая AVR, STM32, ESP32, Raspberry Pi Pico.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Платформа Arduino предоставляет универсальный API, абстрагированный от железа и одинаковый на разных типах микроконтроллеров. Если ваша программа использует только этот API, она будет работать на любом микроконтроллере, для которого есть реализация платформы Arduino. (Это основной плюс, другой такой платформы пока нет).</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Платформа Arduino работает поверх нативной программной платформы, специфичной для каждого микроконтроллера. Поэтому, все возможности нативной платформы (регистры, функции HAL, API ESP-IDF) будут в полной мере доступны прямо в скетче Arduino. Если не хватает возможностей API Arduino, всегда можно использовать любые возможности нативной платформы.</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Как мы раскроем основные преимущества платформы Arduino, исходя из сказанного выше? Мы можем писать портируемый между разными архитектурами микроконтроллеров код. Благодаря портируемости Arduino, производители дисплеев, датчиков, всяких дополнительных модулей, микросхем управляемых по I2C и прочего, просто выкладывают драйвер для Arduino, и он может работать на любом микроконтроллере, будь то STM32, AVR, ESP32 и прочие. Write once, deploy everywhere!</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Но! Здесь надо сразу понять очень важную вещь. Любое портируемое, абстрагированное, универсальное решение - неизбежно проигрывает в эффективности непортируемому, неуниверсальному, прибитому к особенностям архитектуры, специализированному под конкретный микроконтроллер решению. Поэтому, программы с использованием платформы Arduino будут есть больше ресурсов, будут работать медленнее, использовать железо менее эффективно. Но это не обязательно плохо. На самом деле, нет разницы, вы используете 5% или 55% ресурсов своего микроконтроллера. Пока у вас есть свободные ресурсы. То есть, напрашивается такой традиционный для любого программирования подход:</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<h2 style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Open Sans','sans-serif'; font-size:12pt; font-weight:600; color:#000000; background-color:#ffffff;">Трехуровневая система (подход)</span></h2>
<ol style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'Arial','sans-serif'; font-size:12pt; color:#000000; background-color:#ffffff;" style=" margin-top:19px; margin-bottom:0px; margin-left:38px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:medium;">Пока проект простой, все делаем через API Arduino, получаем максимально портируемый код.</span></li>
<li style=" font-family:'Arial','sans-serif'; font-size:12pt; color:#000000; background-color:#ffffff;" style=" margin-top:0px; margin-bottom:0px; margin-left:38px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:medium;">Проект развивается. Эффективности начинает не хватать - в нужных местах, бутылочных голышках, начинаем использовать API нативной платформы.</span></li>
<li style=" font-family:'Arial','sans-serif'; font-size:12pt; color:#000000; background-color:#ffffff;" style=" margin-top:0px; margin-bottom:0px; margin-left:38px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:medium;">Если проект еще дальше развивается и усложняется, приходится выжимать из железа все возможности какие есть - отказ от платформы Arduino, перенос проекта на нативную платформу полностью.</span></li></ol>
<p style=" margin-top:0px; margin-bottom:19px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial','sans-serif'; font-size:12pt; color:#000000; background-color:#ffffff;">Все эти три этапа мы рассмотрим в этом цикле статей, в последующих частях.</span></p>
<p style=" margin-top:0px; margin-bottom:19px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial','sans-serif'; font-size:12pt; color:#000000; background-color:#ffffff;">А сейчас начнем с первой части, но сразу разберем как это делать эффективно.</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:19px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Arial','sans-serif'; font-size:12pt; color:#000000;"><br /></p>
<h2 style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Open Sans','sans-serif'; font-size:12pt; font-weight:600; color:#000000; background-color:#ffffff;">ЧТО ТАКОЕ IDE и почему так не любят Arduino IDE</span></h2>
<p style=" margin-top:0px; margin-bottom:19px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial','sans-serif'; font-size:12pt; color:#000000; background-color:#ffffff;">Для новичка IDE это бог и царь. Это такая волшебная программа, которая «делает хорошо». Без IDE вообще нельзя запрограммировать ничего. Или можно? Но как?</span></p>
<p style=" margin-top:0px; margin-bottom:19px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial','sans-serif'; font-size:12pt; color:#000000; background-color:#ffffff;">На самом деле, любая IDE устроена довольно просто. В основном, это всего лишь текстовый редактор, специализированный для написания кода. Но когда вы написали код - его надо откомпилировать, собрать прошивку. А потом записать прошивку в микроконтроллер. И вот тут сюрприз! Это делает не IDE! Ваша IDE только запускает в фоне утилиты командной строки, которые и компилируют ваш код. Потом вызывает утилиту командной строки, которая записывает код в микроконтроллер.</span></p>
<p style=" margin-top:0px; margin-bottom:19px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial','sans-serif'; font-size:12pt; color:#000000; background-color:#ffffff;">Получается, что мы можем взять любой текстовый редактор кода (да хоть Блокнот, но лучше специализированный редактор), которых имеется на любой вкус, и написать код скетча. Потом вызвать те самые утилиты командной строки, которые его компилируют и прошивают в микроконтроллер. И получить то же самое. Arduino IDE просто объединяет все это в одной программе, чтобы было удобно.</span></p>
<p style=" margin-top:0px; margin-bottom:19px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial','sans-serif'; font-size:12pt; color:#000000; background-color:#ffffff;">Но на самом деле Arduino IDE это не лучший представитель мира IDE. Она черезчур тяжеловесна, предоставляя при этом минимум возможностей, и скрывая многую полезную информацию по умолчанию. И основная функция - текстовый редактор - реализована в ней совсем примитивно. Не идет ни в какое сравнение с удобством Vim или Emacs. Отказавшись от Arduino IDE, можно делать все то же самое, на гораздо более слабой машине, заметно быстрее, заметно лучше понимая что происходит, и тратя заметно меньше нервов.</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:19px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Arial','sans-serif'; font-size:12pt; color:#000000;"><br /></p>
<h2 style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Open Sans','sans-serif'; font-size:12pt; font-weight:600; color:#000000; background-color:#ffffff;">РАБОТА С ARDUINO В КОНСОЛИ</span></h2>
<p style=" margin-top:0px; margin-bottom:19px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial','sans-serif'; font-size:12pt; color:#000000; background-color:#ffffff;">Итак, выбор текстового редактора оставим за читателем. Можно использовать любой, какой больше нравится. Главный вопрос - где взять Arduino для командной строки теперь? Нам нужно установить Arduino-CLI (</span><a href="https://arduino.github.io/arduino-cli/dev/"><span style=" font-family:'Arial','sans-serif'; font-size:12pt; text-decoration: underline; color:#000000; background-color:#ffffff;">https://arduino.github.io/arduino-cli/dev/</span></a><span style=" font-family:'Arial','sans-serif'; font-size:12pt; color:#000000; background-color:#ffffff;">). Набор утилит доступен для всех ОС, для Linux - еще и для ARM. Но, поскольку этот проект является полным СПО, он присутствует просто в репозиториях дистриутивов Linux. То есть - устанавливаем пакет arduino-cli из репозитория.</span></p>
<p style=" margin-top:0px; margin-bottom:19px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial','sans-serif'; font-size:12pt; color:#000000; background-color:#ffffff;">Теперь создадим минимальный скетч, на котором мы можем проверить, как идет сборка прошивки в arduino-cli. Для простоты, напишем скетч блинкалки светодиодом на нашей плате. Практически на всех отладочных платах есть хотя бы один светодиод, помигаем им. Наберем вот такую программу и сохраним в файл blink.ino. Имя файла должно совпадать с именем папки, в которой сохранен этот файл! Поэтому создадим папку blink и поместим файл blink.ino в нее.</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:19px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Arial','sans-serif'; font-size:12pt; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">// the setup function runs once when you press reset or power the board</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">void setup() {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">  // initialize digital pin LED_BUILTIN as an output.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">  pinMode(LED_BUILTIN, OUTPUT);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">}</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'FreeMono'; color:#6a1009;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">// the loop function runs over and over again forever</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">void loop() {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">  digitalWrite(LED_BUILTIN, HIGH);   // turn the LED on (HIGH is the voltage level)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">  delay(1000);                       // wait for a second</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">  digitalWrite(LED_BUILTIN, LOW);    // turn the LED off by making the voltage LOW</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">  delay(1000);                       // wait for a second</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">}</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial','sans-serif'; font-size:12pt; color:#000000; background-color:#ffffff;">Функция </span><span style=" font-family:'Droid Sans Mono','monospace','sans-serif'; font-size:12pt; color:#000000; background-color:#ffffff;">setup</span><span style=" font-family:'Arial','sans-serif'; font-size:12pt; color:#000000; background-color:#ffffff;"> вызывается один раз, при включении платы. У нас она настраивает ножку LED_BUILTIN, к которой подключен светодиод распаянный на плате, как выходную. Далее в функции loop, которая вызывается раз за разом при работе, ножка включается и выключается функцией digitalWrite.</span></p>
<p style=" margin-top:0px; margin-bottom:19px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial','sans-serif'; font-size:12pt; color:#000000; background-color:#ffffff;">Обратите внимание, что вся работа в этом скетче делается только через функции Arduino! А это значит, что на любой совместимой плате, с любым микроконтроллером, будет работать вот этот скетч, без каких-либо изменений. Если написать два таких примера без платформы Arduino, для Atmega358 и для STM32F411, то увидите что они отличаются чуть менее чем полностью. Ножки настраиваются по-разному, ножки включаются и выключаются по-разному (похож принцип, но конкретные названия регистров совсем разные). STM32F411 еще потребует инициализации тактового генератора, простыней кода на пол-экрана. А с Arduino у нас получается один и тот же скетч, который работает и там и там. И еще на многих платформах.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial','sans-serif'; font-size:12pt; color:#000000; background-color:#ffffff;">Далее, вся работа сводится к вызовам утилиты arduino-cli с нужными ключами. Это позволяет сделать все то же, что делается в Arduino IDE. Рассмотрим простейший пример. Пусть у нас есть скетч, написанный в текстовом редакторе, надо его собрать и прошить в микроконтроллер. Я предпочитаю для этих задач, использовать GNU Make. Можно применить и скрипт на bash, но Make имеет ряд удобств. Правда, сейчас они не сильно проявятся из-за дубовости arduino-cli. Поместим в папку </span><span style=" font-family:'Droid Sans Mono','monospace','sans-serif'; font-size:12pt; color:#000000; background-color:#ffffff;">blink</span><span style=" font-family:'Arial','sans-serif'; font-size:12pt; color:#000000; background-color:#ffffff;"> файл </span><span style=" font-family:'Droid Sans Mono','monospace','sans-serif'; font-size:12pt; color:#000000; background-color:#ffffff;">Makefile</span><span style=" font-family:'Arial','sans-serif'; font-size:12pt; color:#000000; background-color:#ffffff;"> Выглядеть наш Makefile будет примерно так:</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">all:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">	arduino-cli -v compile -e --fqbn STMicroelectronics:stm32:Nucleo_64 --board-options &quot;pnum=NUCLEO_F411RE&quot;</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'FreeMono'; color:#6a1009;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">upload:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">	arduino-cli -v upload -e --fqbn STMicroelectronics:stm32:Nucleo_64 --board-options &quot;pnum=NUCLEO_F411RE&quot;</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'FreeMono'; color:#6a1009;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">flash:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">	st-flash write build/STMicroelectronics.stm32.Nucleo_64/Nucleo_64.ino.bin 0x8000000</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'FreeMono'; color:#6a1009;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">monitor:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">	arduino-cli monitor -p /dev/ttyACM0 --config &quot;baudrate=115200&quot;</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'FreeMono'; color:#6a1009;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">erase:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">	st-flash erase</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:19px; -qt-block-indent:0; text-indent:0px; font-family:'Droid Sans Mono','monospace','sans-serif'; font-size:12pt; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial','sans-serif'; font-size:12pt; color:#000000; background-color:#ffffff;">Теперь разберем его построчно. Если вы не знакомы с синтаксисом Make, прочитайте про него сначала. Кратко - Makefile состоит из целей, для каждой из них прописаны команды, как эту цель собрать. Цели здесь - это all, upload, flash и т. д. После цели ставим двоеточие, на следующей строке с отступом пишем команды, нужные для реализации цели. По умолчанию, если выполнить </span><span style=" font-family:'Droid Sans Mono','monospace','sans-serif'; font-size:12pt; color:#000000; background-color:#ffffff;">make</span><span style=" font-family:'Arial','sans-serif'; font-size:12pt; color:#000000; background-color:#ffffff;"> в каталоге с нашим Makefile, собирается цель all. Разберем опции ее команды.</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:19px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Droid Sans Mono','monospace','sans-serif'; font-size:12pt; color:#000000; background-color:#ffffff;">-v</span><span style=" font-family:'Arial','sans-serif'; font-size:12pt; color:#000000; background-color:#ffffff;"> - это флаг, который включает подробную информацию по ходу сборки.</span></p>
<p style=" margin-top:0px; margin-bottom:19px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Droid Sans Mono','monospace','sans-serif'; font-size:12pt; color:#000000; background-color:#ffffff;">compile</span><span style=" font-family:'Arial','sans-serif'; font-size:12pt; color:#000000; background-color:#ffffff;"> - команда «компилировать».</span></p>
<p style=" margin-top:0px; margin-bottom:19px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Droid Sans Mono','monospace','sans-serif'; font-size:12pt; color:#000000; background-color:#ffffff;">-e</span><span style=" font-family:'Arial','sans-serif'; font-size:12pt; color:#000000; background-color:#ffffff;"> - файлы с бинарной прошивкой, помещать в папку проекта, а не в temp. Нам это надо включать обязательно, чтобы потом работали команды для прошивки в микроконтроллер без зубодродительных путей в temp.</span></p>
<p style=" margin-top:0px; margin-bottom:19px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Droid Sans Mono','monospace','sans-serif'; font-size:12pt; color:#000000; background-color:#ffffff;">--fqbn</span><span style=" font-family:'Arial','sans-serif'; font-size:12pt; color:#000000; background-color:#ffffff;"> - полное название борды (отладочной платы, под которую все это делается). Вот с этим несколько сложнее. В моем примере это плата Nucleo-64. Это имя платы, надо уметь найти для своей платы. Для этого вызываем команду </span><span style=" font-family:'Droid Sans Mono','monospace','sans-serif'; font-size:12pt; color:#000000; background-color:#ffffff;">arduino-cli board list</span><span style=" font-family:'Arial','sans-serif'; font-size:12pt; color:#000000; background-color:#ffffff;"> при подключенной плате. Но работает это далеко не всегда! Для моей Nucleo-64, просто выводится Unknown вместо имени платы. Поэтому ищем FQBN из списка вручную, список получаем командой </span><span style=" font-family:'Droid Sans Mono','monospace','sans-serif'; font-size:12pt; color:#000000; background-color:#ffffff;">arduino-cli board listall</span><span style=" font-family:'Arial','sans-serif'; font-size:12pt; color:#000000; background-color:#ffffff;">. В левой колонке - названия плат, в правой FQBN, просто копируем его как есть и подставляем в опцию </span><span style=" font-family:'Droid Sans Mono','monospace','sans-serif'; font-size:12pt; color:#000000; background-color:#ffffff;">--fqbn</span><span style=" font-family:'Arial','sans-serif'; font-size:12pt; color:#000000; background-color:#ffffff;">.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Droid Sans Mono','monospace','sans-serif'; font-size:12pt; color:#000000; background-color:#ffffff;">--board-options &quot;pnum=NUCLEO_F411RE&quot;</span><span style=" font-family:'Arial','sans-serif'; font-size:12pt; color:#000000; background-color:#ffffff;"> - мало одного FQBN. Борда может иметь несколько вариантов, например моя Nucleo-64 имеет микроконтроллер STM32F411RE, и это не есдинственный и не дефолтный вариант Nucleo-64. Поэтому надо указывать еще и pnum. И надо тоже знать, какие варианты pnum есть для вашей борды. Для этого выполняем команду </span><span style=" font-family:'Droid Sans Mono','monospace','sans-serif'; font-size:12pt; color:#000000; background-color:#ffffff;">arduino-cli board details --fqbn STMicroelectronics:stm32:Nucleo_64</span><span style=" font-family:'Arial','sans-serif'; font-size:12pt; color:#000000; background-color:#ffffff;">. И видим для этой борды, с одним и тем же названием Nucleo-64, список из штук 20 разных вариантов pnum (то есть на эти борды может ставится штук 20 разных микроконтроллеров, какой-то из них - ваш. На чипе написано название).</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial','sans-serif'; font-size:12pt; color:#000000; background-color:#ffffff;">Вот и все! Эта команда соберет скетч. Обратите внимание, что мы не указываем тут файл скетча. И другие файлы, если у вас проект состоит из нескольких модулей. Система сборки Arduino находит их сама, она просто собирает все что лежит в папке проекта. После сборки, в папке </span><span style=" font-family:'Droid Sans Mono','monospace','sans-serif'; font-size:12pt; color:#000000; background-color:#ffffff;">build</span><span style=" font-family:'Arial','sans-serif'; font-size:12pt; color:#000000; background-color:#ffffff;"> внутри проекта мы получим бинарники прошивки в разных форматах.</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Arial','sans-serif'; font-size:12pt; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:19px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial','sans-serif'; font-size:12pt; color:#000000; background-color:#ffffff;">Теперь это надо записать в микроконтроллер. Для этого цель upload. Что в ней:</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:19px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Arial','sans-serif'; font-size:12pt; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">upload - команда «загрузить».</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:19px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:19px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial','sans-serif'; font-size:12pt; color:#000000; background-color:#ffffff;">Все остальные опции те же самые, что при сборке. Эта команда находит программатор, или способ прошивки, прописанный в глубине Arduino для вашей платы, и заливает прошивку. Для Nucleo-64 - используется программатор ST-Link, распаянный на самой плате, и работающий в режиме Mass Storage. То есть, ОС видит подключенную плату как флешку, </span><span style=" font-family:'Droid Sans Mono','monospace','sans-serif'; font-size:12pt; color:#000000; background-color:#ffffff;">arduino-cli</span><span style=" font-family:'Arial','sans-serif'; font-size:12pt; color:#000000; background-color:#ffffff;"> просто кидает файл прошивки на эту «флешку». Это просто, но имеет свои минусы. Поэтому рассмотрим еще второй способ прошивки - через не связанную с arduino, родную утилиту </span><span style=" font-family:'Droid Sans Mono','monospace','sans-serif'; font-size:12pt; color:#000000; background-color:#ffffff;">st-flash</span><span style=" font-family:'Arial','sans-serif'; font-size:12pt; color:#000000; background-color:#ffffff;"> от STM32. Для этого цель </span><span style=" font-family:'Droid Sans Mono','monospace','sans-serif'; font-size:12pt; color:#000000; background-color:#ffffff;">flash</span><span style=" font-family:'Arial','sans-serif'; font-size:12pt; color:#000000; background-color:#ffffff;">. Внутри нее - стандартная команда заливки прошивки через st-flash. Теперь используется тот же программатор STLink, распаянный на плате, но уже в нормальном режиме - непосредственно, STLink`a. В этой команде нам надо указать путь в bin файлу прошивки.</span></p>
<p style=" margin-top:0px; margin-bottom:19px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial','sans-serif'; font-size:12pt; color:#000000; background-color:#ffffff;">А что, если надо полностью стереть flash память микроконтроллера? Я вообще не нашел как это сделать нормально средствами Arduino. Поэтому используем родной </span><span style=" font-family:'Droid Sans Mono','monospace','sans-serif'; font-size:12pt; color:#000000; background-color:#ffffff;">st-flash</span><span style=" font-family:'Arial','sans-serif'; font-size:12pt; color:#000000; background-color:#ffffff;">, цель </span><span style=" font-family:'Droid Sans Mono','monospace','sans-serif'; font-size:12pt; color:#000000; background-color:#ffffff;">erase</span><span style=" font-family:'Arial','sans-serif'; font-size:12pt; color:#000000; background-color:#ffffff;"> в Makefile.</span></p>
<p style=" margin-top:0px; margin-bottom:19px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial','sans-serif'; font-size:12pt; color:#000000; background-color:#ffffff;">Ну и конечно же, самая фишка Arduino IDE - отладочный терминал! Как мы его заменим? Очень просто - для этого выполняем </span><span style=" font-family:'Droid Sans Mono','monospace','sans-serif'; font-size:12pt; color:#000000; background-color:#ffffff;">make monitor</span><span style=" font-family:'Arial','sans-serif'; font-size:12pt; color:#000000; background-color:#ffffff;">. Цель </span><span style=" font-family:'Droid Sans Mono','monospace','sans-serif'; font-size:12pt; color:#000000; background-color:#ffffff;">monitor</span><span style=" font-family:'Arial','sans-serif'; font-size:12pt; color:#000000; background-color:#ffffff;"> запускает режим терминала прямо в… терминале Linux! Здесь:</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:19px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Arial','sans-serif'; font-size:12pt; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:19px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Droid Sans Mono','monospace','sans-serif'; font-size:12pt; color:#000000; background-color:#ffffff;">-p</span><span style=" font-family:'Arial','sans-serif'; font-size:12pt; color:#000000; background-color:#ffffff;"> - указываем виртуальный COM порт, который создается при подключении платы. Найти его не трудно командой </span><span style=" font-family:'Droid Sans Mono','monospace','sans-serif'; font-size:12pt; color:#000000; background-color:#ffffff;">dmesg</span><span style=" font-family:'Arial','sans-serif'; font-size:12pt; color:#000000; background-color:#ffffff;"> сразу после втыкания платы. Читаем ее вывод, и там все видно.</span></p>
<p style=" margin-top:0px; margin-bottom:19px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Droid Sans Mono','monospace','sans-serif'; font-size:12pt; color:#000000; background-color:#ffffff;">--config &quot;baudrate=115200&quot;</span><span style=" font-family:'Arial','sans-serif'; font-size:12pt; color:#000000; background-color:#ffffff;"> - настраиваем скорость порта. В вашем скетче задана скорость для Serial интерфейса, задаем здесь точно такую же.</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:19px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:19px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial','sans-serif'; font-size:12pt; color:#000000; background-color:#ffffff;">После этого, все что в скетче печатается через Serial, мы начинаем видеть в терминале Linux, из которого вызвана команда.</span></p>
<p style=" margin-top:0px; margin-bottom:19px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial','sans-serif'; font-size:12pt; color:#000000; background-color:#ffffff;">Если у вас другая отладочная плата, надо заменить в </span><span style=" font-family:'Droid Sans Mono','monospace','sans-serif'; font-size:12pt; color:#000000; background-color:#ffffff;">Makefile</span><span style=" font-family:'Arial','sans-serif'; font-size:12pt; color:#000000; background-color:#ffffff;"> значения FQBN и pname. Если платформа не STM32, то цели </span><span style=" font-family:'Droid Sans Mono','monospace','sans-serif'; font-size:12pt; color:#000000; background-color:#ffffff;">flash</span><span style=" font-family:'Arial','sans-serif'; font-size:12pt; color:#000000; background-color:#ffffff;"> и </span><span style=" font-family:'Droid Sans Mono','monospace','sans-serif'; font-size:12pt; color:#000000; background-color:#ffffff;">erase</span><span style=" font-family:'Arial','sans-serif'; font-size:12pt; color:#000000; background-color:#ffffff;"> надо убрать. Для сборки прошивки, заливки ее на плату, и подключения монитора сообщений выполняем:</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:19px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Arial','sans-serif'; font-size:12pt; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">$ make</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">$ make upload</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">$ make monitor</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:19px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Droid Sans Mono','monospace','sans-serif'; font-size:12pt; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:19px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial','sans-serif'; font-size:12pt; color:#000000; background-color:#ffffff;">Вот - базовая работа с Arduino из командной строки. Помимо этого, конечно же, понадобится установить модули среды Arduino для вашей борды, и библиотеки Arduino, если вы их используете. Это может быть сделано либо через Arduino IDE, и все утановленное в ней будет доступно в arduino-cli. Либо через сам </span><span style=" font-family:'Droid Sans Mono','monospace','sans-serif'; font-size:12pt; color:#000000; background-color:#ffffff;">arduino-cli</span><span style=" font-family:'Arial','sans-serif'; font-size:12pt; color:#000000; background-color:#ffffff;">, как это сделать я подробно расписывать не буду, все понятно по документации на </span><span style=" font-family:'Droid Sans Mono','monospace','sans-serif'; font-size:12pt; color:#000000; background-color:#ffffff;">arduino-cli</span><span style=" font-family:'Arial','sans-serif'; font-size:12pt; color:#000000; background-color:#ffffff;">.</span></p>
<p style=" margin-top:0px; margin-bottom:19px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial','sans-serif'; font-size:12pt; color:#000000; background-color:#ffffff;">Теперь мы можем писать скетчи на Arduino API, компилировать их и прошивать. То есть уровень 1 по моей трехуровневой системе. В следующей части рассмотрим практический пример такого скетча, с переходом на уровень 2 (нативные возможности).</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:19px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Arial','sans-serif'; font-size:12pt; color:#000000;"><br /></p></body></html>